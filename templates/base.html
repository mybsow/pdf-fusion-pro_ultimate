<!-- ============================================
     SYSTÈME D'ÉVALUATION SIMPLIFIÉ
     ============================================ -->
<div id="ratingPopup" class="rating-popup" style="display: none;">
    <div class="rating-content">
        <button id="closeRating" class="rating-close">&times;</button>
        <h4><i class="fas fa-star me-2"></i>Évaluez votre expérience</h4>
        <p class="text-muted mb-3">Comment avez-vous trouvé PDF Fusion Pro Ultimate ?</p>
        
        <div class="stars mb-3">
            <i class="fas fa-star star" data-value="1"></i>
            <i class="fas fa-star star" data-value="2"></i>
            <i class="fas fa-star star" data-value="3"></i>
            <i class="fas fa-star star" data-value="4"></i>
            <i class="fas fa-star star" data-value="5"></i>
        </div>
        
        <div class="rating-feedback" style="display: none;">
            <textarea id="feedbackText" class="form-control mb-2" 
                      placeholder="Vos suggestions (optionnel)..." rows="2"></textarea>
            <button id="submitRating" class="btn btn-primary btn-sm">Envoyer</button>
        </div>
        
        <div class="text-muted small mt-2">
            <i class="fas fa-lock me-1"></i> Vos retours sont anonymes
        </div>
    </div>
</div>

<style>
/* Styles de base */
.rating-popup {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    z-index: 9999;
    width: 320px;
    max-width: 90%;
    border: 1px solid #e9ecef;
}

.rating-content {
    padding: 1.5rem;
    position: relative;
}

.rating-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6c757d;
    cursor: pointer;
}

.stars {
    font-size: 2rem;
    color: #dee2e6;
    cursor: pointer;
}

.star:hover,
.star.active {
    color: #ffc107;
}

.rating-trigger {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #3498db;
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    z-index: 9998;
    border: none;
    font-size: 1.5rem;
}
</style>

<script>
// Version simplifiée et fiable
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ Système d\'évaluation chargé');
    
    // Vérifier si déjà évalué
    const hasRated = localStorage.getItem('pdfFusionRated') === 'true';
    
    if (!hasRated) {
        // Créer le bouton déclencheur
        const trigger = document.createElement('button');
        trigger.className = 'rating-trigger';
        trigger.innerHTML = '<i class="fas fa-star"></i>';
        trigger.title = 'Évaluer PDF Fusion Pro';
        document.body.appendChild(trigger);
        
        // Éléments
        const popup = document.getElementById('ratingPopup');
        const closeBtn = document.getElementById('closeRating');
        const stars = document.querySelectorAll('.star');
        const feedbackDiv = document.querySelector('.rating-feedback');
        const feedbackText = document.getElementById('feedbackText');
        const submitBtn = document.getElementById('submitRating');
        
        let selectedRating = 0;
        
        // Ouvrir popup
        trigger.addEventListener('click', function() {
            popup.style.display = 'block';
            trigger.style.display = 'none';
        });
        
        // Fermer popup
        closeBtn.addEventListener('click', function() {
            popup.style.display = 'none';
            trigger.style.display = 'flex';
            resetStars();
        });
        
        // Gestion des étoiles
        stars.forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.value);
                
                stars.forEach((s, index) => {
                    s.classList.toggle('active', index < selectedRating);
                    s.style.color = index < selectedRating ? '#ffc107' : '#dee2e6';
                });
                
                if (feedbackDiv) {
                    feedbackDiv.style.display = 'block';
                }
            });
        });
        
        // Soumission
        if (submitBtn) {
            submitBtn.addEventListener('click', function() {
                if (selectedRating === 0) {
                    alert('Veuillez sélectionner une note');
                    return;
                }
                
                const feedback = feedbackText ? feedbackText.value.trim() : '';
                
                // Envoyer au serveur
                fetch('/api/rating', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rating: selectedRating,
                        feedback: feedback,
                        page: window.location.pathname
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Merci pour votre évaluation !');
                        localStorage.setItem('pdfFusionRated', 'true');
                        popup.style.display = 'none';
                        trigger.style.display = 'none';
                        resetStars();
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'envoi');
                });
            });
        }
        
        function resetStars() {
            selectedRating = 0;
            stars.forEach(star => {
                star.classList.remove('active');
                star.style.color = '#dee2e6';
            });
            if (feedbackDiv) feedbackDiv.style.display = 'none';
            if (feedbackText) feedbackText.value = '';
        }
        
        // Afficher après 30 secondes
        setTimeout(() => {
            if (!hasRated) {
                popup.style.display = 'block';
                trigger.style.display = 'none';
            }
        }, 30000);
    }
});
</script>