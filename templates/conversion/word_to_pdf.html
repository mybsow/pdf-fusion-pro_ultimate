{% extends "conversion/conversion_base.html" %}

{% block title %}{{ _('Word vers PDF - %(title)s', title=title) }}{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload -->
<div id="step1Content">
    <div class="text-center mb-4">
        <i class="fas fa-file-word upload-icon" style="color: #2b579a;"></i>
        <h3>{{ _('Convertissez votre document Word en PDF') }}</h3>
        <p class="text-muted">{{ _('Transformez vos fichiers DOC/DOCX en PDF avec une mise en page préservée') }}</p>
    </div>

    <!-- Zone d'upload avec UploadManager -->
    <div id="wordPdfUploadZone" 
         class="upload-zone-pro upload-zone" 
         data-info-id="fileInfo"
         data-btn-id="convertBtn"
         style="cursor: pointer;">
        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
        <h4>{{ _('Glissez-déposez votre document Word ici') }}</h4>
        <p class="text-muted">{{ _('ou') }}</p>
        <input type="file" class="file-input" accept=".doc,.docx" style="display: none;">
        <p class="text-muted small mt-3">
            <i class="fas fa-info-circle"></i> 
            {{ _('Formats acceptés : DOC, DOCX (jusqu\'à 50MB)') }}
        </p>
    </div>

    <!-- Liste des fichiers -->
    <div id="fileInfo" class="file-list mt-4"></div>
    <div id="wordPdfUploadZoneThumbnails" class="upload-thumbnails d-flex flex-wrap gap-2 mt-3"></div>

    <!-- Options de conversion -->
    <div class="file-info-card mt-4">
        <h5 class="mb-4">
            <i class="fas fa-cog me-2"></i>{{ _('Options de conversion') }}
        </h5>
        
        <div class="row g-4">
            <div class="col-md-6">
                <label for="pageFormat" class="form-label fw-bold">{{ _('Format de page') }}</label>
                <select class="form-select" id="pageFormat">
                    <option value="A4" selected>{{ _('A4 (210 × 297 mm)') }}</option>
                    <option value="Letter">{{ _('Letter (8.5 × 11 in)') }}</option>
                    <option value="Legal">{{ _('Legal (8.5 × 14 in)') }}</option>
                    <option value="A3">{{ _('A3 (297 × 420 mm)') }}</option>
                    <option value="A5">{{ _('A5 (148 × 210 mm)') }}</option>
                </select>
                <small class="text-muted">{{ _('Format standard pour la plupart des documents') }}</small>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-bold">{{ _('Orientation') }}</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="orientation" id="portrait" value="portrait" checked>
                    <label class="btn btn-outline-primary" for="portrait">
                        <i class="fas fa-file-alt me-1"></i>{{ _('Portrait') }}
                    </label>
                    
                    <input type="radio" class="btn-check" name="orientation" id="landscape" value="landscape">
                    <label class="btn btn-outline-primary" for="landscape">
                        <i class="fas fa-file me-1"></i>{{ _('Paysage') }}
                    </label>
                </div>
            </div>

            <div class="col-md-6">
                <label for="margins" class="form-label fw-bold">{{ _('Marges') }}</label>
                <select class="form-select" id="margins">
                    <option value="normal" selected>{{ _('Normales (2.5 cm)') }}</option>
                    <option value="narrow">{{ _('Étroites (1.3 cm)') }}</option>
                    <option value="moderate">{{ _('Modérées (1.9 cm)') }}</option>
                    <option value="wide">{{ _('Larges (5 cm)') }}</option>
                </select>
                <small class="text-muted">{{ _('Espace entre le texte et les bords') }}</small>
            </div>
            
            <div class="col-md-6">
                <label for="quality" class="form-label fw-bold">{{ _('Qualité') }}</label>
                <select class="form-select" id="quality">
                    <option value="standard" selected>{{ _('Standard (équilibré)') }}</option>
                    <option value="high">{{ _('Haute (pour impression)') }}</option>
                    <option value="screen">{{ _('Optimisé écran (taille réduite)') }}</option>
                    <option value="print">{{ _('Optimisé impression') }}</option>
                </select>
                <small class="text-muted">{{ _('Influence la taille du fichier final') }}</small>
            </div>

            <div class="col-12">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="preserveLayout" checked>
                            <label class="form-check-label" for="preserveLayout">
                                <strong>{{ _('Conserver la mise en page') }}</strong>
                                <small class="d-block text-muted">{{ _('Préserve les polices, tableaux et styles') }}</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="includeBookmarks" checked>
                            <label class="form-check-label" for="includeBookmarks">
                                <strong>{{ _('Inclure les signets') }}</strong>
                                <small class="d-block text-muted">{{ _('Pour une navigation plus facile') }}</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="protectPDF">
                    <label class="form-check-label" for="protectPDF">
                        <strong>{{ _('Protéger le PDF') }}</strong>
                        <small class="d-block text-muted">{{ _('Ajouter un mot de passe et des restrictions') }}</small>
                    </label>
                </div>
            </div>

            <!-- Protection options (cachées par défaut) -->
            <div id="protectionOptions" class="col-12" style="display: none;">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">{{ _('Mot de passe') }}</label>
                                <input type="password" class="form-control" id="password" placeholder="{{ _('Min. 6 caractères') }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="permissions" class="form-label">{{ _('Permissions') }}</label>
                                <select class="form-select" id="permissions">
                                    <option value="view">{{ _('Visualisation seule') }}</option>
                                    <option value="print">{{ _('Impression autorisée') }}</option>
                                    <option value="edit">{{ _('Modification autorisée') }}</option>
                                    <option value="full">{{ _('Toutes permissions') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <i class="fas fa-info-circle me-2"></i>
            <strong>{{ _('Format PDF :') }}</strong> {{ _('Compatible avec tous les lecteurs PDF. Les polices sont intégrées pour une reproduction fidèle.') }}
        </div>
    </div>

    <!-- Bouton de conversion -->
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg px-5" id="convertBtn" onclick="startConversion()" disabled>
            <i class="fas fa-sync-alt me-2"></i>{{ _('Convertir en PDF') }}
        </button>
        <button class="btn btn-outline-secondary btn-lg ms-2" onclick="resetConversion()">
            <i class="fas fa-redo me-2"></i>{{ _('Réinitialiser') }}
        </button>
    </div>
</div>

<!-- Étape 2: Conversion en cours -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-cog fa-spin fa-4x text-primary"></i>
        </div>
        
        <h3 class="mb-4">{{ _('Conversion en cours...') }}</h3>
        <p class="text-muted mb-4" id="conversionMessage">
            {{ _('Analyse et conversion de votre document Word...') }}
        </p>
        
        <div class="progress-container mx-auto" style="max-width: 500px;">
            <div class="progress-bar" id="conversionProgress" style="width: 0%;"></div>
        </div>
        
        <div class="row mt-5 g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Pages estimées') }}</h6>
                        <div class="display-6 text-primary" id="estimatedPages">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Qualité') }}</h6>
                        <div class="display-6 text-success" id="qualitySetting">{{ _('Standard') }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Format') }}</h6>
                        <div class="display-6 text-warning" id="formatSetting">A4</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 text-muted small" id="conversionDetails">
            <i class="fas fa-file-word me-1"></i> {{ _('Lecture du document Word...') }}
        </div>
    </div>
</div>

<!-- Étape 3: Téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation" style="background-color: #2b579a;">
            <i class="fas fa-file-pdf"></i>
        </div>
        
        <h3 class="mb-3">{{ _('Conversion réussie !') }}</h3>
        <p class="text-muted mb-4">
            {{ _('Votre PDF est prêt au téléchargement') }}
        </p>
        
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <i class="fas fa-file-pdf fa-2x text-danger mb-3"></i>
                        <h5 id="pdfFileName">{{ _('document.pdf') }}</h5>
                        <p class="small text-muted" id="pdfFileInfo">
                            {{ _('Taille: 0 MB | Pages: 0') }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <i class="fas fa-info-circle fa-2x text-primary mb-3"></i>
                        <h5>{{ _('Détails') }}</h5>
                        <p class="small text-muted" id="conversionDetailsInfo">
                            {{ _('Format: A4<br>Orientation: Portrait<br>Qualité: Standard') | safe }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <a href="#" class="btn btn-success btn-lg px-5" id="downloadLink">
                <i class="fas fa-download me-2"></i>{{ _('Télécharger PDF') }}
            </a>
            
            <button class="btn btn-outline-primary btn-lg px-5" onclick="resetConversion()">
                <i class="fas fa-redo me-2"></i>{{ _('Nouvelle conversion') }}
            </button>
        </div>

        <div class="mt-4">
            <div class="btn-group" role="group">
                <a href="{{ url_for('conversion.universal_converter', conversion_type='pdf-en-word') }}" 
                   class="btn btn-outline-secondary">
                    <i class="fas fa-exchange-alt me-1"></i>{{ _('PDF vers Word') }}
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let downloadUrl = null;

function startConversion() {
    const uploadManager = window.uploadManagers['wordPdfUploadZone'];
    if (!uploadManager || uploadManager.getFiles().length === 0) {
        showError('{{ _("Veuillez sélectionner un document Word") }}');
        return;
    }

    const file = uploadManager.getFiles()[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('page_format', document.getElementById('pageFormat').value);
    formData.append('orientation', document.querySelector('input[name="orientation"]:checked').value);
    formData.append('margins', document.getElementById('margins').value);
    formData.append('quality', document.getElementById('quality').value);
    formData.append('preserve_layout', document.getElementById('preserveLayout').checked);
    formData.append('include_bookmarks', document.getElementById('includeBookmarks').checked);
    formData.append('protect_pdf', document.getElementById('protectPDF').checked);
    
    if (document.getElementById('protectPDF').checked) {
        formData.append('password', document.getElementById('password').value);
        formData.append('permissions', document.getElementById('permissions').value);
    }

    // Passer à l'étape 2
    updateStep(2);
    
    // Mettre à jour les informations d'estimation
    const pages = Math.max(1, Math.ceil(file.size / 15000));
    document.getElementById('estimatedPages').textContent = pages;
    
    const qualitySelect = document.getElementById('quality');
    const qualityText = qualitySelect.options[qualitySelect.selectedIndex].text.split(' ')[0];
    document.getElementById('qualitySetting').textContent = qualityText;
    
    document.getElementById('formatSetting').textContent = document.getElementById('pageFormat').value;
    
    // Simuler la progression
    simulateConversion(file, pages);
    
    // Envoyer la requête
    fetch('{{ url_for("conversion.universal_converter", conversion_type="word-en-pdf") }}', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        if (response.ok) {
            const blob = await response.blob();
            downloadUrl = window.URL.createObjectURL(blob);
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = file.name.replace(/\.[^/.]+$/, '') + '.pdf';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (match && match[1]) {
                    filename = match[1].replace(/['"]/g, '');
                }
            }
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            
            // Simuler les statistiques finales
            simulateFinalStats(file, pages, filename);
            
            updateStep(3);
        } else {
            const error = await response.text();
            showError('{{ _("Erreur lors de la conversion :") }} ' + error);
            updateStep(1);
        }
    })
    .catch(error => {
        showError('{{ _("Erreur :") }} ' + error.message);
        updateStep(1);
    });
}

function simulateConversion(file, totalPages) {
    const progressBar = document.getElementById('conversionProgress');
    const conversionMessage = document.getElementById('conversionMessage');
    const conversionDetails = document.getElementById('conversionDetails');
    
    const steps = [
        { percent: 15, message: "{{ _('Lecture du document Word...') }}", detail: "{{ _('Analyse de la structure') }}" },
        { percent: 30, message: "{{ _('Extraction des styles...') }}", detail: "{{ _('Préservation des polices') }}" },
        { percent: 50, message: "{{ _('Traitement des images...') }}", detail: "{{ _('Optimisation des graphiques') }}" },
        { percent: 70, message: "{{ _('Génération du PDF...') }}", detail: "{{ _('Création des pages') }}" },
        { percent: 90, message: "{{ _('Application des paramètres...') }}", detail: "{{ _('Configuration finale') }}" },
        { percent: 100, message: "{{ _('Conversion terminée !') }}", detail: "{{ _('Préparation du téléchargement') }}" }
    ];
    
    let stepIndex = 0;
    
    function updateProgress() {
        if (stepIndex < steps.length) {
            const step = steps[stepIndex];
            progressBar.style.width = step.percent + '%';
            conversionMessage.textContent = step.message;
            conversionDetails.innerHTML = `<i class="fas fa-cog fa-spin me-1"></i> ${step.detail}`;
            
            stepIndex++;
            setTimeout(updateProgress, 800);
        } else {
            conversionDetails.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i> {{ _("Conversion terminée !") }}';
        }
    }
    
    updateProgress();
}

function simulateFinalStats(file, pages, filename) {
    const sizeMB = (file.size * 0.6 / (1024 * 1024)).toFixed(2); // Estimation 60% de la taille originale
    
    document.getElementById('pdfFileName').textContent = filename;
    document.getElementById('pdfFileInfo').textContent = `{{ _('Taille:') }} ${sizeMB} MB | {{ _('Pages:') }} ${pages}`;
    
    const format = document.getElementById('pageFormat').value;
    const orientation = document.querySelector('input[name="orientation"]:checked').value === 'portrait' ? '{{ _("Portrait") }}' : '{{ _("Paysage") }}';
    const quality = document.getElementById('quality').options[document.getElementById('quality').selectedIndex].text;
    
    document.getElementById('conversionDetailsInfo').innerHTML = 
        `{{ _('Format:') }} ${format}<br>
         {{ _('Orientation:') }} ${orientation}<br>
         {{ _('Qualité:') }} ${quality}`;
}

// Gestion de l'affichage des options de protection
document.addEventListener('DOMContentLoaded', function() {
    const protectCheckbox = document.getElementById('protectPDF');
    const protectionOptions = document.getElementById('protectionOptions');
    const passwordInput = document.getElementById('password');
    
    protectCheckbox.addEventListener('change', function() {
        protectionOptions.style.display = this.checked ? 'block' : 'none';
    });
    
    // Validation du mot de passe
    passwordInput.addEventListener('input', function() {
        if (this.value && this.value.length < 6) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    // Activer/désactiver le bouton selon la sélection de fichier
    const uploadManager = window.uploadManagers?.['wordPdfUploadZone'];
    if (uploadManager) {
        const originalHandleFiles = uploadManager.handleFiles;
        uploadManager.handleFiles = function(fileList) {
            originalHandleFiles.call(this, fileList);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
        
        const originalRemoveFile = uploadManager.removeFile;
        uploadManager.removeFile = function(index) {
            originalRemoveFile.call(this, index);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
    }
});

function resetConversion() {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
        downloadUrl = null;
    }
    
    const uploadManager = window.uploadManagers['wordPdfUploadZone'];
    if (uploadManager) {
        while (uploadManager.getFiles().length > 0) {
            uploadManager.removeFile(0);
        }
    }
    
    updateStep(1);
}

window.addEventListener('beforeunload', () => {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
    }
});
</script>
{% endblock %}