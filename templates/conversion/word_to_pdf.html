{% extends "conversion/conversion_base.html" %}

{% block title %}Word vers PDF - {{ title }}{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload -->
<div id="step1Content">
    <div class="text-center mb-4">
        <i class="fas fa-file-word upload-icon" style="color: #2b579a;"></i>
        <h3>Convertissez votre document Word en PDF</h3>
        <p class="text-muted">Transformez vos fichiers DOC/DOCX en PDF avec une mise en page préservée</p>
    </div>

    <!-- Zone d'upload avec UploadManager -->
    <div id="wordPdfUploadZone" 
         class="upload-zone-pro upload-zone" 
         data-info-id="fileInfo"
         data-btn-id="convertBtn"
         style="cursor: pointer;">
        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
        <h4>Glissez-déposez votre document Word ici</h4>
        <p class="text-muted">ou</p>
        <input type="file" class="file-input" accept=".doc,.docx" style="display: none;">
        <p class="text-muted small mt-3">
            <i class="fas fa-info-circle"></i> 
            Formats acceptés : DOC, DOCX (jusqu'à 50MB)
        </p>
    </div>

    <!-- Liste des fichiers -->
    <div id="fileInfo" class="file-list mt-4"></div>
    <div id="wordPdfUploadZoneThumbnails" class="upload-thumbnails d-flex flex-wrap gap-2 mt-3"></div>

    <!-- Options de conversion -->
    <div class="file-info-card mt-4">
        <h5 class="mb-4">
            <i class="fas fa-cog me-2"></i>Options de conversion
        </h5>
        
        <div class="row g-4">
            <div class="col-md-6">
                <label for="pageFormat" class="form-label fw-bold">Format de page</label>
                <select class="form-select" id="pageFormat">
                    <option value="A4" selected>A4 (210 × 297 mm)</option>
                    <option value="Letter">Letter (8.5 × 11 in)</option>
                    <option value="Legal">Legal (8.5 × 14 in)</option>
                    <option value="A3">A3 (297 × 420 mm)</option>
                    <option value="A5">A5 (148 × 210 mm)</option>
                </select>
                <small class="text-muted">Format standard pour la plupart des documents</small>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-bold">Orientation</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="orientation" id="portrait" value="portrait" checked>
                    <label class="btn btn-outline-primary" for="portrait">
                        <i class="fas fa-file-alt me-1"></i>Portrait
                    </label>
                    
                    <input type="radio" class="btn-check" name="orientation" id="landscape" value="landscape">
                    <label class="btn btn-outline-primary" for="landscape">
                        <i class="fas fa-file me-1"></i>Paysage
                    </label>
                </div>
            </div>

            <div class="col-md-6">
                <label for="margins" class="form-label fw-bold">Marges</label>
                <select class="form-select" id="margins">
                    <option value="normal" selected>Normales (2.5 cm)</option>
                    <option value="narrow">Étroites (1.3 cm)</option>
                    <option value="moderate">Modérées (1.9 cm)</option>
                    <option value="wide">Larges (5 cm)</option>
                </select>
                <small class="text-muted">Espace entre le texte et les bords</small>
            </div>
            
            <div class="col-md-6">
                <label for="quality" class="form-label fw-bold">Qualité</label>
                <select class="form-select" id="quality">
                    <option value="standard" selected>Standard (équilibré)</option>
                    <option value="high">Haute (pour impression)</option>
                    <option value="screen">Optimisé écran (taille réduite)</option>
                    <option value="print">Optimisé impression</option>
                </select>
                <small class="text-muted">Influence la taille du fichier final</small>
            </div>

            <div class="col-12">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="preserveLayout" checked>
                            <label class="form-check-label" for="preserveLayout">
                                <strong>Conserver la mise en page</strong>
                                <small class="d-block text-muted">Préserve les polices, tableaux et styles</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="includeBookmarks" checked>
                            <label class="form-check-label" for="includeBookmarks">
                                <strong>Inclure les signets</strong>
                                <small class="d-block text-muted">Pour une navigation plus facile</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="protectPDF">
                    <label class="form-check-label" for="protectPDF">
                        <strong>Protéger le PDF</strong>
                        <small class="d-block text-muted">Ajouter un mot de passe et des restrictions</small>
                    </label>
                </div>
            </div>

            <!-- Protection options (cachées par défaut) -->
            <div id="protectionOptions" class="col-12" style="display: none;">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Mot de passe</label>
                                <input type="password" class="form-control" id="password" placeholder="Min. 6 caractères">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="permissions" class="form-label">Permissions</label>
                                <select class="form-select" id="permissions">
                                    <option value="view">Visualisation seule</option>
                                    <option value="print">Impression autorisée</option>
                                    <option value="edit">Modification autorisée</option>
                                    <option value="full">Toutes permissions</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Format PDF :</strong> Compatible avec tous les lecteurs PDF. Les polices sont intégrées pour une reproduction fidèle.
        </div>
    </div>

    <!-- Bouton de conversion -->
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg px-5" id="convertBtn" onclick="startConversion()" disabled>
            <i class="fas fa-sync-alt me-2"></i>Convertir en PDF
        </button>
        <button class="btn btn-outline-secondary btn-lg ms-2" onclick="resetConversion()">
            <i class="fas fa-redo me-2"></i>Réinitialiser
        </button>
    </div>
</div>

<!-- Étape 2: Conversion en cours -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-cog fa-spin fa-4x text-primary"></i>
        </div>
        
        <h3 class="mb-4">Conversion en cours...</h3>
        <p class="text-muted mb-4" id="conversionMessage">
            Analyse et conversion de votre document Word...
        </p>
        
        <div class="progress-container mx-auto" style="max-width: 500px;">
            <div class="progress-bar" id="conversionProgress" style="width: 0%;"></div>
        </div>
        
        <div class="row mt-5 g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Pages estimées</h6>
                        <div class="display-6 text-primary" id="estimatedPages">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Qualité</h6>
                        <div class="display-6 text-success" id="qualitySetting">Standard</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Format</h6>
                        <div class="display-6 text-warning" id="formatSetting">A4</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 text-muted small" id="conversionDetails">
            <i class="fas fa-file-word me-1"></i> Lecture du document Word...
        </div>
    </div>
</div>

<!-- Étape 3: Téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation" style="background-color: #2b579a;">
            <i class="fas fa-file-pdf"></i>
        </div>
        
        <h3 class="mb-3">Conversion réussie !</h3>
        <p class="text-muted mb-4">
            Votre PDF est prêt au téléchargement
        </p>
        
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <i class="fas fa-file-pdf fa-2x text-danger mb-3"></i>
                        <h5 id="pdfFileName">document.pdf</h5>
                        <p class="small text-muted" id="pdfFileInfo">
                            Taille: 0 MB | Pages: 0
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <i class="fas fa-info-circle fa-2x text-primary mb-3"></i>
                        <h5>Détails</h5>
                        <p class="small text-muted" id="conversionDetailsInfo">
                            Format: A4<br>
                            Orientation: Portrait<br>
                            Qualité: Standard
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <a href="#" class="btn btn-success btn-lg px-5" id="downloadLink">
                <i class="fas fa-download me-2"></i>Télécharger PDF
            </a>
            
            <button class="btn btn-outline-primary btn-lg px-5" onclick="resetConversion()">
                <i class="fas fa-redo me-2"></i>Nouvelle conversion
            </button>
        </div>

        <div class="mt-4">
            <div class="btn-group" role="group">
                <a href="{{ url_for('conversion.universal_converter', conversion_type='pdf-en-word') }}" 
                   class="btn btn-outline-secondary">
                    <i class="fas fa-exchange-alt me-1"></i>PDF vers Word
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let downloadUrl = null;

function startConversion() {
    const uploadManager = window.uploadManagers['wordPdfUploadZone'];
    if (!uploadManager || uploadManager.getFiles().length === 0) {
        showError('Veuillez sélectionner un document Word');
        return;
    }

    const file = uploadManager.getFiles()[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('page_format', document.getElementById('pageFormat').value);
    formData.append('orientation', document.querySelector('input[name="orientation"]:checked').value);
    formData.append('margins', document.getElementById('margins').value);
    formData.append('quality', document.getElementById('quality').value);
    formData.append('preserve_layout', document.getElementById('preserveLayout').checked);
    formData.append('include_bookmarks', document.getElementById('includeBookmarks').checked);
    formData.append('protect_pdf', document.getElementById('protectPDF').checked);
    
    if (document.getElementById('protectPDF').checked) {
        formData.append('password', document.getElementById('password').value);
        formData.append('permissions', document.getElementById('permissions').value);
    }

    // Passer à l'étape 2
    updateStep(2);
    
    // Mettre à jour les informations d'estimation
    const pages = Math.max(1, Math.ceil(file.size / 15000));
    document.getElementById('estimatedPages').textContent = pages;
    document.getElementById('qualitySetting').textContent = 
        document.getElementById('quality').options[document.getElementById('quality').selectedIndex].text.split(' ')[0];
    document.getElementById('formatSetting').textContent = document.getElementById('pageFormat').value;
    
    // Simuler la progression
    simulateConversion(file, pages);
    
    // Envoyer la requête
    fetch('{{ url_for("conversion.universal_converter", conversion_type="word-en-pdf") }}', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        if (response.ok) {
            const blob = await response.blob();
            downloadUrl = window.URL.createObjectURL(blob);
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = file.name.replace(/\.[^/.]+$/, '') + '.pdf';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (match && match[1]) {
                    filename = match[1].replace(/['"]/g, '');
                }
            }
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            
            // Simuler les statistiques finales
            simulateFinalStats(file, pages, filename);
            
            updateStep(3);
        } else {
            const error = await response.text();
            showError('Erreur lors de la conversion : ' + error);
            updateStep(1);
        }
    })
    .catch(error => {
        showError('Erreur : ' + error.message);
        updateStep(1);
    });
}

function simulateConversion(file, totalPages) {
    const progressBar = document.getElementById('conversionProgress');
    const conversionMessage = document.getElementById('conversionMessage');
    const conversionDetails = document.getElementById('conversionDetails');
    
    const steps = [
        { percent: 15, message: "Lecture du document Word...", detail: "Analyse de la structure" },
        { percent: 30, message: "Extraction des styles...", detail: "Préservation des polices" },
        { percent: 50, message: "Traitement des images...", detail: "Optimisation des graphiques" },
        { percent: 70, message: "Génération du PDF...", detail: "Création des pages" },
        { percent: 90, message: "Application des paramètres...", detail: "Configuration finale" },
        { percent: 100, message: "Conversion terminée !", detail: "Préparation du téléchargement" }
    ];
    
    let stepIndex = 0;
    
    function updateProgress() {
        if (stepIndex < steps.length) {
            const step = steps[stepIndex];
            progressBar.style.width = step.percent + '%';
            conversionMessage.textContent = step.message;
            conversionDetails.innerHTML = `<i class="fas fa-cog fa-spin me-1"></i> ${step.detail}`;
            
            stepIndex++;
            setTimeout(updateProgress, 800);
        } else {
            conversionDetails.innerHTML = '<i class="fas fa-check-circle text-success me-1"></i> Conversion terminée !';
        }
    }
    
    updateProgress();
}

function simulateFinalStats(file, pages, filename) {
    const sizeMB = (file.size * 0.6 / (1024 * 1024)).toFixed(2); // Estimation 60% de la taille originale
    
    document.getElementById('pdfFileName').textContent = filename;
    document.getElementById('pdfFileInfo').textContent = `Taille: ${sizeMB} MB | Pages: ${pages}`;
    
    const format = document.getElementById('pageFormat').value;
    const orientation = document.querySelector('input[name="orientation"]:checked').value === 'portrait' ? 'Portrait' : 'Paysage';
    const quality = document.getElementById('quality').options[document.getElementById('quality').selectedIndex].text;
    
    document.getElementById('conversionDetailsInfo').innerHTML = 
        `Format: ${format}<br>
         Orientation: ${orientation}<br>
         Qualité: ${quality}`;
}

// Gestion de l'affichage des options de protection
document.addEventListener('DOMContentLoaded', function() {
    const protectCheckbox = document.getElementById('protectPDF');
    const protectionOptions = document.getElementById('protectionOptions');
    const passwordInput = document.getElementById('password');
    
    protectCheckbox.addEventListener('change', function() {
        protectionOptions.style.display = this.checked ? 'block' : 'none';
    });
    
    // Validation du mot de passe
    passwordInput.addEventListener('input', function() {
        if (this.value && this.value.length < 6) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    // Activer/désactiver le bouton selon la sélection de fichier
    const uploadManager = window.uploadManagers?.['wordPdfUploadZone'];
    if (uploadManager) {
        const originalHandleFiles = uploadManager.handleFiles;
        uploadManager.handleFiles = function(fileList) {
            originalHandleFiles.call(this, fileList);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
        
        const originalRemoveFile = uploadManager.removeFile;
        uploadManager.removeFile = function(index) {
            originalRemoveFile.call(this, index);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
    }
});

function resetConversion() {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
        downloadUrl = null;
    }
    
    const uploadManager = window.uploadManagers['wordPdfUploadZone'];
    if (uploadManager) {
        while (uploadManager.getFiles().length > 0) {
            uploadManager.removeFile(0);
        }
    }
    
    updateStep(1);
}

window.addEventListener('beforeunload', () => {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
    }
});
</script>
{% endblock %}