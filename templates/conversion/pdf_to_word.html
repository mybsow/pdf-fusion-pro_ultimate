{% extends "conversion/conversion_base.html" %}

{% block title %}PDF vers Word - Convertisseur{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload -->
<div id="step1Content">
    <div class="text-center mb-4">
        <i class="fas fa-file-word upload-icon" style="color: #2b579a;"></i>
        <h3>Convertissez votre PDF en document Word</h3>
        <p class="text-muted">Transformez vos PDF en documents Word modifiables avec mise en page préservée</p>
    </div>

    <!-- Zone d'upload avec UploadManager -->
    <div id="pdfWordUploadZone" 
         class="upload-zone-pro upload-zone" 
         data-info-id="fileInfo"
         data-btn-id="convertBtn"
         style="cursor: pointer;">
        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
        <h4>Glissez-déposez votre fichier PDF ici</h4>
        <p class="text-muted">ou</p>
        <input type="file" class="file-input" accept=".pdf" style="display: none;">
        <p class="text-muted small mt-3">
            <i class="fas fa-info-circle"></i> 
            Format accepté : PDF (jusqu'à 50MB)
        </p>
    </div>

    <!-- Liste des fichiers et miniatures -->
    <div id="fileInfo" class="file-list mt-4"></div>
    <div id="pdfWordUploadZoneThumbnails" class="upload-thumbnails d-flex flex-wrap gap-2 mt-3"></div>

    <!-- Options de conversion -->
    <div class="file-info-card mt-4">
        <h5 class="mb-4">
            <i class="fas fa-cog me-2"></i>Options de conversion
        </h5>
        
        <div class="row g-4">
            <div class="col-md-6">
                <label for="extractionMode" class="form-label fw-bold">Mode d'extraction</label>
                <select class="form-select" id="extractionMode">
                    <option value="text">Texte uniquement (plus léger)</option>
                    <option value="layout" selected>Conserver la mise en page (recommandé)</option>
                    <option value="full">Texte et images (complet)</option>
                </select>
                <small class="text-muted">Choisissez le niveau de détail à conserver</small>
            </div>
            
            <div class="col-md-6">
                <label for="language" class="form-label fw-bold">Langue du document</label>
                <select class="form-select" id="language">
                    <option value="fra" selected>Français</option>
                    <option value="eng">Anglais</option>
                    <option value="deu">Allemand</option>
                    <option value="spa">Espagnol</option>
                    <option value="ita">Italien</option>
                </select>
                <small class="text-muted">Améliore la reconnaissance du texte</small>
            </div>

            <div class="col-12">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="detectTables" checked>
                            <label class="form-check-label" for="detectTables">
                                <strong>Détecter les tableaux</strong>
                                <small class="d-block text-muted">Convertit automatiquement les tableaux en format Word</small>
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="preserveFormatting" checked>
                            <label class="form-check-label" for="preserveFormatting">
                                <strong>Conserver la mise en forme</strong>
                                <small class="d-block text-muted">Maintient les polices, tailles et styles</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Format Word :</strong> Le fichier généré est au format DOCX, compatible avec Microsoft Word 2007 et versions ultérieures, ainsi qu'avec LibreOffice et Google Docs.
        </div>
    </div>

    <!-- Bouton de conversion -->
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg px-5" id="convertBtn" onclick="startConversion()" disabled>
            <i class="fas fa-sync-alt me-2"></i>Convertir en Word
        </button>
        <button class="btn btn-outline-secondary btn-lg ms-2" onclick="resetConversion()">
            <i class="fas fa-redo me-2"></i>Réinitialiser
        </button>
    </div>
</div>

<!-- Étape 2: Conversion en cours -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-cog fa-spin fa-4x text-primary"></i>
        </div>
        
        <h3 class="mb-4">Conversion en cours...</h3>
        <p class="text-muted mb-4" id="conversionMessage">
            Analyse et conversion de votre PDF...
        </p>
        
        <div class="progress-container mx-auto" style="max-width: 500px;">
            <div class="progress-bar" id="conversionProgress" style="width: 0%;"></div>
        </div>
        
        <div class="row mt-5 g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Pages traitées</h6>
                        <div class="display-6 text-primary" id="processedPages">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Paragraphes</h6>
                        <div class="display-6 text-success" id="extractedParagraphs">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Images détectées</h6>
                        <div class="display-6 text-warning" id="detectedImages">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4 text-muted small" id="conversionDetails">
            <i class="fas fa-file-pdf me-1"></i> Extraction du texte...
        </div>
    </div>
</div>

<!-- Étape 3: Téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation">
            <i class="fas fa-file-word"></i>
        </div>
        
        <h3 class="mb-3">Conversion réussie !</h3>
        <p class="text-muted mb-4">
            Votre document Word est prêt
        </p>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <a href="#" class="btn btn-success btn-lg px-5" id="downloadLink">
                <i class="fas fa-download me-2"></i>Télécharger Word
            </a>
            
            <button class="btn btn-outline-primary btn-lg px-5" onclick="resetConversion()">
                <i class="fas fa-redo me-2"></i>Nouvelle conversion
            </button>
        </div>

        <!-- Résumé de la conversion -->
        <div class="row mt-5 g-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Pages</h6>
                        <div class="display-6 text-primary" id="finalPages">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Mots</h6>
                        <div class="display-6 text-success" id="finalWords">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Caractères</h6>
                        <div class="display-6 text-warning" id="finalChars">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Taille</h6>
                        <div class="display-6 text-info" id="finalSize">0 MB</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aperçu du texte extrait -->
        <div class="mt-5">
            <h5 class="mb-4">Aperçu du texte extrait</h5>
            <div class="card border-0 shadow-sm">
                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                    <p class="text-muted fst-italic" id="textPreview">
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let downloadUrl = null;

function startConversion() {
    const uploadManager = window.uploadManagers['pdfWordUploadZone'];
    if (!uploadManager || uploadManager.getFiles().length === 0) {
        showError('Veuillez sélectionner un fichier PDF');
        return;
    }

    const file = uploadManager.getFiles()[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('mode', document.getElementById('extractionMode').value);
    formData.append('language', document.getElementById('language').value);
    formData.append('detect_tables', document.getElementById('detectTables').checked);
    formData.append('preserve_formatting', document.getElementById('preserveFormatting').checked);

    // Passer à l'étape 2
    updateStep(2);
    
    // Estimer le nombre de pages basé sur la taille du fichier
    const estimatedPages = Math.max(1, Math.floor(file.size / (200 * 1024)));
    
    // Simuler la progression
    simulateConversion(estimatedPages);
    
    // Envoyer la requête
    fetch('{{ url_for("conversion.universal_converter", conversion_type="pdf-en-word") }}', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        if (response.ok) {
            const blob = await response.blob();
            downloadUrl = window.URL.createObjectURL(blob);
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = file.name.replace('.pdf', '') + '.docx';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (match && match[1]) {
                    filename = match[1].replace(/['"]/g, '');
                }
            }
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            
            // Simuler les statistiques finales
            simulateFinalStats(file, estimatedPages);
            
            updateStep(3);
        } else {
            const error = await response.text();
            showError('Erreur lors de la conversion : ' + error);
            updateStep(1);
        }
    })
    .catch(error => {
        showError('Erreur : ' + error.message);
        updateStep(1);
    });
}

function simulateConversion(totalPages) {
    const progressBar = document.getElementById('conversionProgress');
    const conversionMessage = document.getElementById('conversionMessage');
    const conversionDetails = document.getElementById('conversionDetails');
    const processedPages = document.getElementById('processedPages');
    const extractedParagraphs = document.getElementById('extractedParagraphs');
    const detectedImages = document.getElementById('detectedImages');
    
    let currentPage = 0;
    let paragraphs = 0;
    let images = 0;
    
    function updateProgress() {
        if (currentPage <= totalPages) {
            const percent = Math.floor((currentPage / totalPages) * 100);
            progressBar.style.width = percent + '%';
            processedPages.textContent = currentPage;
            
            // Simuler l'extraction de contenu
            if (currentPage > 0) {
                paragraphs += Math.floor(Math.random() * 10) + 5;
                extractedParagraphs.textContent = paragraphs;
                
                if (currentPage % 3 === 0) {
                    images += Math.floor(Math.random() * 2) + 1;
                    detectedImages.textContent = images;
                }
            }
            
            if (currentPage === 0) {
                conversionMessage.textContent = "Analyse du PDF...";
                conversionDetails.innerHTML = '<i class="fas fa-search me-1"></i> Lecture de la structure du document';
            } else if (currentPage < totalPages) {
                conversionMessage.textContent = `Extraction de la page ${currentPage}/${totalPages}`;
                conversionDetails.innerHTML = `<i class="fas fa-file-text me-1"></i> Traitement de la page ${currentPage}`;
            } else {
                conversionMessage.textContent = "Génération du document Word...";
                conversionDetails.innerHTML = '<i class="fas fa-file-word me-1"></i> Création du fichier DOCX';
            }
            
            currentPage++;
            
            if (currentPage <= totalPages) {
                setTimeout(updateProgress, 400);
            }
        }
    }
    
    updateProgress();
}

function simulateFinalStats(file, pages) {
    // Estimer le nombre de mots (environ 300 mots par page)
    const words = pages * 300;
    const chars = words * 5; // 5 caractères par mot en moyenne
    const sizeMB = (file.size * 1.1 / (1024 * 1024)).toFixed(2);
    
    document.getElementById('finalPages').textContent = pages;
    document.getElementById('finalWords').textContent = words.toLocaleString();
    document.getElementById('finalChars').textContent = chars.toLocaleString();
    document.getElementById('finalSize').textContent = sizeMB + ' MB';
    
    // Mettre à jour l'aperçu du texte
    const preview = document.getElementById('textPreview');
    if (preview) {
        const sampleTexts = [
            "Le document a été converti avec succès. La mise en page a été préservée et le texte est maintenant entièrement modifiable dans Microsoft Word, LibreOffice ou Google Docs.",
            "La conversion a conservé la structure du document original, y compris les titres, les paragraphes et la mise en forme du texte.",
            "Les tableaux ont été détectés et convertis en tableaux Word modifiables. Les images ont été intégrées au document final."
        ];
        preview.textContent = sampleTexts.join(' ');
    }
}

function resetConversion() {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
        downloadUrl = null;
    }
    
    const uploadManager = window.uploadManagers['pdfWordUploadZone'];
    if (uploadManager) {
        while (uploadManager.getFiles().length > 0) {
            uploadManager.removeFile(0);
        }
    }
    
    updateStep(1);
}

// Activer/désactiver le bouton selon la sélection de fichier
document.addEventListener('DOMContentLoaded', function() {
    const uploadManager = window.uploadManagers?.['pdfWordUploadZone'];
    if (uploadManager) {
        const originalHandleFiles = uploadManager.handleFiles;
        uploadManager.handleFiles = function(fileList) {
            originalHandleFiles.call(this, fileList);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
        
        const originalRemoveFile = uploadManager.removeFile;
        uploadManager.removeFile = function(index) {
            originalRemoveFile.call(this, index);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
    }
});

window.addEventListener('beforeunload', () => {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
    }
});
</script>
{% endblock %}