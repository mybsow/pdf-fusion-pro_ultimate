{% extends "conversion/conversion_base.html" %}

{% block title %}PDF vers DOC - Convertisseur{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload -->
<div id="step1Content">
    <div class="upload-zone-pro" id="pdfToDocUploadZone" data-info-id="pdfToDocFileInfo" data-btn-id="convertBtn">
        <div class="upload-inner">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <h4 class="upload-title">Déposez votre PDF ici</h4>
            <p class="upload-subtitle">Glissez-déposez ou cliquez pour sélectionner</p>
            <div class="upload-info">PDF uniquement • Taille max : 50MB</div>
        </div>
        <input type="file" accept=".pdf" style="display:none;">
    </div>
    
    <div id="pdfToDocFileInfo" class="file-list mt-3"></div>
    <div id="pdfToDocUploadZoneThumbnails" class="upload-thumbnails d-flex flex-wrap gap-2 mt-3"></div>
    
    <!-- Options de conversion -->
    <div class="mt-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-cog me-2"></i>Options de conversion
                </h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Mode d'extraction</label>
                        <select class="form-select" id="extractionMode">
                            <option value="text">Texte uniquement</option>
                            <option value="layout" selected>Conserver la mise en page</option>
                            <option value="full">Texte et images</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Langue du document</label>
                        <select class="form-select" id="language">
                            <option value="fra" selected>Français</option>
                            <option value="eng">Anglais</option>
                            <option value="deu">Allemand</option>
                            <option value="spa">Espagnol</option>
                            <option value="ita">Italien</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="detectTables" checked>
                            <label class="form-check-label">
                                Détecter les tableaux
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="preserveFormatting" checked>
                            <label class="form-check-label">
                                Conserver la mise en forme
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-2">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Format DOC :</strong> Compatible avec Microsoft Word 97-2003 et anciennes versions.
                </div>
                
                <div class="action-buttons mt-4">
                    <button class="btn btn-primary btn-lg" id="convertBtn" disabled>
                        <i class="fas fa-play me-2"></i>
                        Convertir en DOC
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Étape 2: Conversion -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="upload-icon mb-4">
            <div class="spinner-border text-primary" style="width: 5rem; height: 5rem;" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
        
        <h3 class="mb-4">Conversion en cours...</h3>
        <p class="text-muted mb-4">Transformation de votre PDF en document DOC</p>
        
        <div class="progress-container">
            <div class="progress-bar" id="conversionProgress"></div>
        </div>
    </div>
</div>

<!-- Étape 3: Téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation">
            <i class="fas fa-file-word"></i>
        </div>
        
        <h3 class="mb-3">Conversion réussie !</h3>
        <p class="text-muted mb-4">
            Votre document DOC est prêt au téléchargement
        </p>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <button class="btn btn-success btn-lg px-4 py-3" id="downloadBtn">
                <i class="fas fa-download me-2"></i>
                Télécharger DOC
            </button>
            
            <button class="btn btn-outline-primary btn-lg px-4 py-3" onclick="resetConverter()">
                <i class="fas fa-redo me-2"></i>
                Nouvelle conversion
            </button>
        </div>
    </div>
</div>

<!-- Formulaire caché pour la soumission POST -->
<form method="POST" 
      action="{{ url_for('conversion.universal_converter', conversion_type='pdf-en-word') }}"
      enctype="multipart/form-data"
      id="hiddenForm"
      style="display: none;">
    <input type="file" name="file" id="hiddenFileInput">
    <input type="hidden" name="output_format" value="doc" id="hiddenOutputFormat">
</form>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/components/upload.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const convertBtn = document.getElementById('convertBtn');
    const uploadManager = window.uploadManagers?.pdfToDocUploadZone;
    
    function updateButtonState() {
        convertBtn.disabled = !uploadManager?.files?.length;
    }
    
    if (uploadManager) {
        const originalHandleFiles = uploadManager.handleFiles;
        uploadManager.handleFiles = function(fileList) {
            originalHandleFiles.call(this, fileList);
            updateButtonState();
        };
        
        const originalRemoveFile = uploadManager.removeFile;
        uploadManager.removeFile = function(index) {
            originalRemoveFile.call(this, index);
            updateButtonState();
        };
    }
    
    convertBtn.addEventListener('click', async function() {
        if (!uploadManager?.files?.length) {
            alert('Veuillez sélectionner un fichier PDF');
            return;
        }
        
        const file = uploadManager.files[0];
        document.getElementById('step1Content').style.display = 'none';
        document.getElementById('step2Content').style.display = 'block';
        
        // Simuler la progression
        const progressBar = document.getElementById('conversionProgress');
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            progressBar.style.width = progress + '%';
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('step2Content').style.display = 'none';
                    document.getElementById('step3Content').style.display = 'block';
                }, 500);
            }
        }, 300);
        
        // Préparer le téléchargement
        const formData = new FormData();
        formData.append('file', file);
        formData.append('mode', document.getElementById('extractionMode').value);
        formData.append('language', document.getElementById('language').value);
        formData.append('detect_tables', document.getElementById('detectTables').checked);
        formData.append('preserve_formatting', document.getElementById('preserveFormatting').checked);
        formData.append('output_format', 'doc');
        
        document.getElementById('downloadBtn').onclick = async function() {
            const response = await fetch("{{ url_for('conversion.universal_converter', conversion_type='pdf-en-word') }}", {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name.replace('.pdf', '') + '.doc';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        };
    });
});

function resetConverter() {
    const uploadManager = window.uploadManagers?.pdfToDocUploadZone;
    if (uploadManager) {
        while (uploadManager.files.length > 0) {
            uploadManager.removeFile(0);
        }
    }
    document.getElementById('step1Content').style.display = 'block';
    document.getElementById('step2Content').style.display = 'none';
    document.getElementById('step3Content').style.display = 'none';
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/components/upload.js') }}"></script>
{% endblock %}