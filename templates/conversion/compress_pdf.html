<!-- templates/conversion/compress_pdf.html -->
{% extends "conversion/conversion_base.html" %}

{% block extra_css %}
{{ super() }}
<style>
.compression-levels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.level-card {
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.level-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.level-card.selected {
    border-color: var(--primary-color);
    background: rgba(231, 76, 60, 0.05);
}

.level-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
}

.compression-preview {
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 1.5rem;
    background: #f8f9fa;
}

.file-comparison {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin: 1rem 0;
}

.file-original, .file-compressed {
    text-align: center;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    min-width: 150px;
}

.savings-badge {
    background: #2ecc71;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
}

.quality-slider {
    padding: 1rem 0;
}

.compression-options {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}
</style>
{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload et configuration -->
<div id="step1Content">
    <div class="upload-zone" id="dropZone">
        <div class="upload-icon">
            <i class="fas fa-compress"></i>
        </div>
        
        <h3>Déposez votre PDF ici</h3>
        <p class="text-muted mb-4">
            Réduisez la taille de votre fichier PDF
        </p>
        
        <p class="small text-muted mb-3">
            <i class="fas fa-info-circle me-1"></i>
            Formats acceptés: .pdf | Taille max: 100MB
        </p>
        
        <input type="file" 
               id="fileInput" 
               class="d-none" 
               accept=".pdf">
        
        <button class="btn btn-primary btn-lg px-4 py-2"
                onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-folder-open me-2"></i>
            Sélectionner un PDF
        </button>
    </div>
    
    <!-- Configuration de la compression -->
    <div id="compressConfig" class="mt-4" style="display: none;">
        <!-- Niveaux de compression -->
        <h5 class="mb-3">
            <i class="fas fa-tachometer-alt me-2"></i>Niveau de compression
        </h5>
        
        <div class="compression-levels">
            <div class="level-card selected" data-level="high" onclick="selectLevel('high')">
                <div class="level-icon" style="background: #2ecc71; color: white;">
                    <i class="fas fa-bolt"></i>
                </div>
                <h6>Haute compression</h6>
                <p class="small text-muted mb-2">
                    Réduction maximale
                </p>
                <div class="badge bg-success">70-90%</div>
            </div>
            
            <div class="level-card" data-level="recommended" onclick="selectLevel('recommended')">
                <div class="level-icon" style="background: #3498db; color: white;">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <h6>Recommandé</h6>
                <p class="small text-muted mb-2">
                    Équilibre qualité/taille
                </p>
                <div class="badge bg-primary">50-70%</div>
            </div>
            
            <div class="level-card" data-level="low" onclick="selectLevel('low')">
                <div class="level-icon" style="background: #f39c12; color: white;">
                    <i class="fas fa-eye"></i>
                </div>
                <h6>Faible compression</h6>
                <p class="small text-muted mb-2">
                    Qualité maximale
                </p>
                <div class="badge bg-warning">20-40%</div>
            </div>
        </div>
        
        <!-- Aperçu de la compression -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-chart-line me-2"></i>Estimation de compression
                </h5>
                
                <div class="compression-preview">
                    <div class="text-center mb-4">
                        <h4 id="compressionEstimate">Taille estimée: 0 MB</h4>
                        <p class="text-muted" id="savingsEstimate">
                            Économie estimée: 0% (0 MB)
                        </p>
                    </div>
                    
                    <div class="file-comparison">
                        <div class="file-original">
                            <i class="fas fa-file-pdf fa-2x text-danger mb-2"></i>
                            <h6>Original</h6>
                            <p class="mb-0" id="originalSize">0 MB</p>
                        </div>
                        
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-arrow-right fa-2x text-muted mb-2"></i>
                            <div class="savings-badge" id="savingsBadge">0%</div>
                        </div>
                        
                        <div class="file-compressed">
                            <i class="fas fa-file-pdf fa-2x text-success mb-2"></i>
                            <h6>Compressé</h6>
                            <p class="mb-0" id="compressedSize">0 MB</p>
                        </div>
                    </div>
                    
                    <div class="quality-slider mt-4">
                        <label class="form-label">
                            Qualité d'image: <span id="qualityValue">75</span>%
                        </label>
                        <input type="range" 
                               class="form-range" 
                               id="qualitySlider" 
                               min="10" 
                               max="100" 
                               value="75"
                               step="5">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Faible qualité</small>
                            <small class="text-muted">Haute qualité</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Options avancées -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-cogs me-2"></i>Options avancées
                </h5>
                
                <div class="compression-options">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="optimizeImages" checked>
                                <label class="form-check-label">
                                    <strong>Optimiser les images</strong>
                                </label>
                                <div class="form-text small">
                                    Réduit la qualité des images dans le PDF
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="removeMetadata" checked>
                                <label class="form-check-label">
                                    <strong>Supprimer les métadonnées</strong>
                                </label>
                                <div class="form-text small">
                                    Enlève les informations cachées
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="downsampleImages" checked>
                                <label class="form-check-label">
                                    <strong>Rééchantillonner les images</strong>
                                </label>
                                <div class="form-text small">
                                    Réduit la résolution des images
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="compressFonts">
                                <label class="form-check-label">
                                    <strong>Compresser les polices</strong>
                                </label>
                                <div class="form-text small">
                                    Réduit la taille des polices intégrées
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Résolution d'image cible</label>
                            <select class="form-select" id="imageResolution">
                                <option value="72">72 DPI (web)</option>
                                <option value="150" selected>150 DPI (standard)</option>
                                <option value="200">200 DPI (bonne qualité)</option>
                                <option value="300">300 DPI (haute qualité)</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Format de sortie</label>
                            <select class="form-select" id="outputFormat">
                                <option value="standard" selected>PDF standard</option>
                                <option value="pdfa">PDF/A (archivage)</option>
                                <option value="screen">PDF écran</option>
                                <option value="ebook">PDF eBook</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informations du fichier -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1" id="fileName"></h5>
                        <p class="text-muted mb-0 small" id="fileDetails"></p>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                        <i class="fas fa-times"></i> Changer
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bouton de compression -->
        <div class="mt-4">
            <button class="btn btn-primary w-100 py-3 btn-lg" onclick="startCompression()">
                <i class="fas fa-compress me-2"></i>
                Compresser le PDF
            </button>
        </div>
    </div>
</div>

<!-- Étape 2: Compression -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="upload-icon mb-4">
            <i class="fas fa-compress fa-spin"></i>
        </div>
        
        <h3>Compression en cours...</h3>
        <p class="text-muted mb-4">
            Optimisation de votre fichier PDF
        </p>
        
        <div class="progress-container">
            <div class="progress-bar" id="compressProgress"></div>
        </div>
        
        <div class="mt-4" id="compressDetails">
            <p class="text-muted small">
                <i class="fas fa-spinner fa-spin me-1"></i>
                Analyse du document...
            </p>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6>Traitement</h6>
                        <p class="small text-muted mb-0" id="processingStep">Analyse</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6>Images optimisées</h6>
                        <p class="small text-muted mb-0" id="optimizedImages">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6>Économie estimée</h6>
                        <p class="small text-muted mb-0" id="currentSavings">0%</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6>Temps estimé</h6>
                        <p class="small text-muted mb-0" id="compressTime">Quelques secondes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Étape 3: Téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation">
            <i class="fas fa-check"></i>
        </div>
        
        <h3 class="mb-3">Compression réussie !</h3>
        <p class="text-muted mb-4">
            Votre PDF compressé est prêt au téléchargement
        </p>
        
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <i class="fas fa-file-pdf fa-2x text-success mb-3"></i>
                        <h5 id="compressedFileName">document_compresse.pdf</h5>
                        <p class="small text-muted" id="compressedFileInfo">
                            Taille: 0 MB | Compression: 0%
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <i class="fas fa-chart-bar fa-2x text-primary mb-3"></i>
                        <h5>Résultats</h5>
                        <p class="small text-muted" id="compressionResults">
                            Économie: 0 MB<br>
                            Taux de compression: 0%
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3">
            <button class="btn btn-success btn-lg px-4" id="downloadBtn">
                <i class="fas fa-download me-2"></i>
                Télécharger PDF
            </button>
            
            <button class="btn btn-outline-primary btn-lg px-4" onclick="resetConverter()">
                <i class="fas fa-redo me-2"></i>
                Nouvelle compression
            </button>
        </div>
        
        <div class="mt-4">
            <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary" onclick="updateStep(1)">
                    <i class="fas fa-sliders-h me-1"></i>
                    Modifier les paramètres
                </button>
                <a href="{{ url_for('conversion.universal_converter', conversion_type='fusionner-pdf') }}" 
                   class="btn btn-outline-secondary">
                    <i class="fas fa-object-group me-1"></i>
                    Fusionner PDF
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;
let selectedLevel = 'high';
let originalSize = 0;

// Gestion du drag & drop
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropZone.classList.add('dragover');
}

function unhighlight() {
    dropZone.classList.remove('dragover');
}

dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFile(files[0]);
}

fileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
        handleFile(this.files[0]);
    }
});

function handleFile(file) {
    if (!file) return;
    
    // Vérifier l'extension
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext !== 'pdf') {
        showError('Veuillez sélectionner un fichier PDF');
        return;
    }
    
    // Vérifier la taille (max 100MB pour compression)
    if (file.size > 100 * 1024 * 1024) {
        showError('Fichier trop volumineux (max 100MB)');
        return;
    }
    
    selectedFile = file;
    originalSize = file.size;
    
    // Afficher la configuration
    document.getElementById('compressConfig').style.display = 'block';
    
    // Mettre à jour l'interface
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileDetails').textContent = 
        `${(file.size / 1024 / 1024).toFixed(2)} MB • PDF`;
    
    // Mettre à jour l'estimation
    updateCompressionEstimate();
    
    // Configurer les événements
    setupEventListeners();
}

function clearFile() {
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('compressConfig').style.display = 'none';
}

function selectLevel(level) {
    selectedLevel = level;
    
    // Mettre à jour l'apparence
    document.querySelectorAll('.level-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-level="${level}"]`).classList.add('selected');
    
    // Mettre à jour le slider de qualité selon le niveau
    const qualitySlider = document.getElementById('qualitySlider');
    switch (level) {
        case 'high':
            qualitySlider.value = 50;
            break;
        case 'recommended':
            qualitySlider.value = 75;
            break;
        case 'low':
            qualitySlider.value = 90;
            break;
    }
    updateQualityValue();
    updateCompressionEstimate();
}

function setupEventListeners() {
    // Mettre à jour l'estimation quand les paramètres changent
    document.getElementById('qualitySlider').addEventListener('input', function() {
        updateQualityValue();
        updateCompressionEstimate();
    });
    
    document.getElementById('optimizeImages').addEventListener('change', updateCompressionEstimate);
    document.getElementById('removeMetadata').addEventListener('change', updateCompressionEstimate);
    document.getElementById('downsampleImages').addEventListener('change', updateCompressionEstimate);
    document.getElementById('compressFonts').addEventListener('change', updateCompressionEstimate);
    document.getElementById('imageResolution').addEventListener('change', updateCompressionEstimate);
    document.getElementById('outputFormat').addEventListener('change', updateCompressionEstimate);
}

function updateQualityValue() {
    const value = document.getElementById('qualitySlider').value;
    document.getElementById('qualityValue').textContent = value;
}

function updateCompressionEstimate() {
    if (!selectedFile) return;
    
    const originalMB = originalSize / 1024 / 1024;
    
    // Facteurs de réduction basés sur les paramètres
    let reductionFactor = 0.5; // Base 50%
    
    // Niveau de compression
    switch (selectedLevel) {
        case 'high':
            reductionFactor = 0.2; // 80% reduction
            break;
        case 'recommended':
            reductionFactor = 0.4; // 60% reduction
            break;
        case 'low':
            reductionFactor = 0.7; // 30% reduction
            break;
    }
    
    // Qualité d'image
    const quality = parseInt(document.getElementById('qualitySlider').value) / 100;
    reductionFactor *= (1.5 - quality); // Plus de réduction si qualité basse
    
    // Options supplémentaires
    if (document.getElementById('optimizeImages').checked) {
        reductionFactor *= 0.8;
    }
    if (document.getElementById('removeMetadata').checked) {
        reductionFactor *= 0.95;
    }
    if (document.getElementById('downsampleImages').checked) {
        reductionFactor *= 0.85;
    }
    if (document.getElementById('compressFonts').checked) {
        reductionFactor *= 0.9;
    }
    
    // Résolution d'image
    const resolution = parseInt(document.getElementById('imageResolution').value);
    if (resolution <= 150) {
        reductionFactor *= 0.8;
    }
    
    // S'assurer que le facteur est entre 0.1 et 0.9
    reductionFactor = Math.max(0.1, Math.min(0.9, reductionFactor));
    
    const compressedMB = originalMB * reductionFactor;
    const savingsMB = originalMB - compressedMB;
    const savingsPercent = ((1 - reductionFactor) * 100).toFixed(1);
    
    // Mettre à jour l'interface
    document.getElementById('originalSize').textContent = `${originalMB.toFixed(2)} MB`;
    document.getElementById('compressedSize').textContent = `${compressedMB.toFixed(2)} MB`;
    document.getElementById('savingsBadge').textContent = `${savingsPercent}%`;
    document.getElementById('compressionEstimate').textContent = 
        `Taille estimée: ${compressedMB.toFixed(2)} MB`;
    document.getElementById('savingsEstimate').textContent = 
        `Économie estimée: ${savingsPercent}% (${savingsMB.toFixed(2)} MB)`;
}

function startCompression() {
    if (!selectedFile) return;
    
    updateStep(2);
    
    // Simuler la progression
    let progress = 0;
    const progressBar = document.getElementById('compressProgress');
    const details = document.getElementById('compressDetails');
    const processingStep = document.getElementById('processingStep');
    const optimizedImages = document.getElementById('optimizedImages');
    const currentSavings = document.getElementById('currentSavings');
    const compressTime = document.getElementById('compressTime');
    
    const steps = [
        { progress: 10, step: "Analyse du PDF...", images: 0, savings: "10%" },
        { progress: 25, step: "Optimisation des images...", images: 3, savings: "25%" },
        { progress: 45, step: "Compression des polices...", images: 5, savings: "40%" },
        { progress: 65, step: "Nettoyage des métadonnées...", images: 7, savings: "55%" },
        { progress: 85, step: "Rééchantillonnage...", images: 9, savings: "70%" },
        { progress: 100, step: "Finalisation...", images: 12, savings: "85%" }
    ];
    
    steps.forEach((step, index) => {
        setTimeout(() => {
            progressBar.style.width = step.progress + '%';
            processingStep.textContent = step.step;
            optimizedImages.textContent = step.images;
            currentSavings.textContent = step.savings;
            
            details.innerHTML = `
                <p class="text-muted small">
                    <i class="fas fa-spinner fa-spin me-1"></i>
                    ${step.step}
                </p>
            `;
            
            // Estimer le temps restant
            const remaining = (steps.length - index - 1) * 0.8;
            compressTime.textContent = remaining < 1 ? 
                'Quelques secondes' : 
                `${Math.ceil(remaining)} seconde(s)`;
            
            // Dernière étape
            if (index === steps.length - 1) {
                setTimeout(() => {
                    // Calculer les résultats finaux
                    const compressedMB = (originalSize / 1024 / 1024) * 0.35; // 65% de réduction
                    const savingsPercent = 65;
                    const savingsMB = (originalSize / 1024 / 1024) - compressedMB;
                    
                    // Mettre à jour les infos finales
                    document.getElementById('compressedFileName').textContent = 
                        `${selectedFile.name.replace('.pdf', '')}_compressed.pdf`;
                    document.getElementById('compressedFileInfo').textContent = 
                        `Taille: ${compressedMB.toFixed(2)} MB | Compression: ${savingsPercent}%`;
                    document.getElementById('compressionResults').innerHTML = `
                        Économie: ${savingsMB.toFixed(2)} MB<br>
                        Taux de compression: ${savingsPercent}%<br>
                        Fichier réduit de ${(originalSize / 1024 / 1024).toFixed(2)} à ${compressedMB.toFixed(2)} MB
                    `;
                    
                    updateStep(3);
                    prepareDownload();
                }, 1000);
            }
        }, index * 1500);
    });
}

function prepareDownload() {
    document.getElementById('downloadBtn').onclick = async () => {
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('level', selectedLevel);
        formData.append('quality', document.getElementById('qualitySlider').value);
        formData.append('optimizeImages', document.getElementById('optimizeImages').checked);
        formData.append('removeMetadata', document.getElementById('removeMetadata').checked);
        formData.append('downsampleImages', document.getElementById('downsampleImages').checked);
        formData.append('compressFonts', document.getElementById('compressFonts').checked);
        formData.append('imageResolution', document.getElementById('imageResolution').value);
        formData.append('outputFormat', document.getElementById('outputFormat').value);
        
        showLoader();
        
        try {
            const response = await fetch("{{ url_for('conversion.universal_converter', conversion_type='compresser-pdf') }}", {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${selectedFile.name.replace('.pdf', '')}_compressed.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } else {
                const error = await response.json();
                showError(error.error || 'Erreur lors de la compression');
                updateStep(1);
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Erreur de connexion au serveur');
            updateStep(1);
        } finally {
            hideLoader();
        }
    };
}

function resetConverter() {
    selectedFile = null;
    fileInput.value = '';
    originalSize = 0;
    selectedLevel = 'high';
    
    document.getElementById('compressConfig').style.display = 'none';
    document.querySelectorAll('.level-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector('[data-level="high"]').classList.add('selected');
    
    // Réinitialiser les valeurs
    document.getElementById('qualitySlider').value = 75;
    updateQualityValue();
    
    updateStep(1);
}
</script>
{% endblock %}
