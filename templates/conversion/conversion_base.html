<!-- templates/conversion/conversion_base.html -->
{% extends "base.html" %}

{% block head %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
:root {
    --primary: #e74c3c; /* Rouge comme le site de référence */
    --primary-dark: #c0392b;
    --light: #f8f9fa;
    --dark: #333;
}

.converter-hero {
    background: linear-gradient(135deg, var(--primary) 0%, #c0392b 100%);
    color: white;
    padding: 4rem 0;
    margin-bottom: 2rem;
}

.upload-zone {
    border: 3px dashed #ddd;
    border-radius: 15px;
    padding: 3rem;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s;
    cursor: pointer;
}

.upload-zone:hover,
.upload-zone.dragover {
    border-color: var(--primary);
    background: rgba(231, 76, 60, 0.05);
}

.converter-icon {
    font-size: 4rem;
    color: var(--primary);
    margin-bottom: 1rem;
}

.converter-steps {
    display: flex;
    justify-content: space-between;
    margin: 3rem 0;
    position: relative;
}

.converter-steps::before {
    content: '';
    position: absolute;
    top: 25px;
    left: 0;
    right: 0;
    height: 2px;
    background: #ddd;
    z-index: 1;
}

.step {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-number {
    width: 50px;
    height: 50px;
    background: #fff;
    border: 3px solid #ddd;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto 10px;
    transition: all 0.3s;
}

.step.active .step-number {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.step.completed .step-number {
    background: #2ecc71;
    border-color: #2ecc71;
    color: white;
}

.file-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 10px;
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    
    <!-- Hero Section -->
    <div class="converter-hero">
        <div class="container text-center">
            <h1 class="display-4">
                <i class="fas fa-exchange-alt me-3"></i>
                {{ title }}
            </h1>
            <p class="lead">Convertissez vos fichiers rapidement et gratuitement</p>
        </div>
    </div>

    <div class="container">
        
        <!-- Steps Tracker -->
        <div class="converter-steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">Télécharger</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">Convertir</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">Télécharger</div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card shadow-lg border-0">
            <div class="card-body p-5">
                
                <!-- Step 1: Upload -->
                <div id="uploadStep">
                    <div class="upload-zone" id="dropZone">
                        <div class="converter-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        
                        <h3>Déposez votre fichier ici</h3>
                        <p class="text-muted mb-4">
                            Glissez-déposez votre fichier {{ from_format }} ou cliquez pour sélectionner
                        </p>
                        
                        <p class="small text-muted mb-3">
                            Formats acceptés: {{ accept }}
                        </p>
                        
                        <input type="file" 
                               id="fileInput" 
                               class="d-none" 
                               accept="{{ accept }}">
                        
                        <button class="btn btn-primary btn-lg"
                                onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>
                            Sélectionner un fichier
                        </button>
                    </div>
                    
                    <!-- File Info -->
                    <div id="fileInfo" class="mt-4" style="display: none;">
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-2"></i>
                                <strong id="fileName"></strong>
                                <span id="fileSize" class="text-muted"></span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="text-center">
                            <button class="btn btn-primary btn-lg" id="convertBtn" onclick="convertFile()">
                                <i class="fas fa-play me-2"></i>
                                Convertir en {{ to_format }}
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Converting -->
                <div id="convertingStep" class="text-center" style="display: none;">
                    <div class="converter-icon mb-4">
                        <i class="fas fa-sync-alt fa-spin"></i>
                    </div>
                    
                    <h3>Conversion en cours...</h3>
                    <p class="text-muted">Veuillez patienter pendant la conversion</p>
                    
                    <div class="progress mt-4" style="height: 10px;">
                        <div id="conversionProgress" 
                             class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Step 3: Download -->
                <div id="downloadStep" class="text-center" style="display: none;">
                    <div class="converter-icon mb-4 text-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    
                    <h3>Conversion réussie !</h3>
                    <p class="text-muted mb-4">Votre fichier {{ to_format }} est prêt</p>
                    
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-success btn-lg" id="downloadBtn">
                            <i class="fas fa-download me-2"></i>
                            Télécharger
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="resetConverter()">
                            <i class="fas fa-redo me-2"></i>
                            Nouvelle conversion
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- Additional Information -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x text-primary mb-3"></i>
                        <h5>Sécurisé</h5>
                        <p class="text-muted small">Vos fichiers sont supprimés automatiquement après conversion</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-bolt fa-2x text-primary mb-3"></i>
                        <h5>Rapide</h5>
                        <p class="text-muted small">Conversion en quelques secondes seulement</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-laptop fa-2x text-primary mb-3"></i>
                        <h5>Accessible</h5>
                        <p class="text-muted small">Utilisez depuis n'importe quel navigateur</p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;

// Initialiser les étapes
function updateStep(stepNumber) {
    // Cacher toutes les étapes
    document.getElementById('uploadStep').style.display = 'none';
    document.getElementById('convertingStep').style.display = 'none';
    document.getElementById('downloadStep').style.display = 'none';
    
    // Afficher l'étape active
    if (stepNumber === 1) {
        document.getElementById('uploadStep').style.display = 'block';
    } else if (stepNumber === 2) {
        document.getElementById('convertingStep').style.display = 'block';
    } else if (stepNumber === 3) {
        document.getElementById('downloadStep').style.display = 'block';
    }
    
    // Mettre à jour le tracker
    document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < stepNumber) {
            step.classList.add('completed');
        } else if (index + 1 === stepNumber) {
            step.classList.add('active');
        }
    });
}

// Gestion du drag & drop
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropZone.classList.add('dragover');
}

function unhighlight() {
    dropZone.classList.remove('dragover');
}

dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFile(files[0]);
}

fileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
        handleFile(this.files[0]);
    }
});

function handleFile(file) {
    if (!file) return;
    
    selectedFile = file;
    
    // Afficher les informations du fichier
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = 
        ` (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
    
    document.getElementById('fileInfo').style.display = 'block';
}

function clearFile() {
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('fileInfo').style.display = 'none';
}

function convertFile() {
    if (!selectedFile) return;
    
    updateStep(2);
    
    // Simuler la progression
    let progress = 0;
    const progressBar = document.getElementById('conversionProgress');
    
    const interval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                updateStep(3);
                prepareDownload();
            }, 500);
        }
    }, 200);
}

function prepareDownload() {
    // Préparer le téléchargement
    document.getElementById('downloadBtn').onclick = async () => {
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        try {
            const response = await fetch("{{ url_for('conversion.universal_converter', conversion_type=conversion_type) }}", {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `converted_${Date.now()}.{{ to_format }}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } else {
                alert('Erreur lors de la conversion');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Erreur lors de la conversion');
        }
    };
}

function resetConverter() {
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('fileInfo').style.display = 'none';
    updateStep(1);
}

// Initialiser
document.addEventListener('DOMContentLoaded', function() {
    updateStep(1);
});
</script>
{% endblock %}
