<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image vers Excel - {{ config.NAME }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/material.min.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        .upload-area {
            border: 3px dashed #FF9800;
            border-radius: 15px;
            padding: 3rem 1rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 2rem;
        }
        
        .upload-area:hover, .upload-area.dragover {
            background: #fff3e0;
            border-color: #F57C00;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #FF9800;
            margin-bottom: 1rem;
        }
        
        .preview-container {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            background: white;
            margin: 1.5rem 0;
            max-height: 400px;
            overflow: auto;
        }
        
        .table-preview {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .table-preview th {
            background: #FF9800;
            color: white;
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #F57C00;
        }
        
        .table-preview td {
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .table-preview tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .detection-results {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .detected-table {
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
        }
        
        .step-indicator:before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: bold;
        }
        
        .step.active .step-number {
            background: #FF9800;
        }
        
        .step.completed .step-number {
            background: #4CAF50;
        }
        
        .format-options {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .format-option {
            flex: 1;
            text-align: center;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .format-option:hover {
            border-color: #FF9800;
            background: #fff3e0;
        }
        
        .format-option.selected {
            border-color: #FF9800;
            background: #FF9800;
            color: white;
        }
    </style>
</head>
<body>
    {% extends "base.html" %}
    
    {% block content %}
    <div class="container py-4">
        <!-- En-tête -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="{{ url_for('conversion.index') }}" class="btn btn-outline-primary mb-3">
                    <i class="fas fa-*">fa-arrow-left</i> Retour aux conversions
                </a>
                <h1 class="display-5"><i class="fas fa-*">fa-table</i> Image vers Excel</h1>
                <p class="lead">Extrayez des tableaux d'images vers Excel avec reconnaissance intelligente</p>
            </div>
        </div>

        <!-- Indicateur d'étapes -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">Upload</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">Détection</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">Options</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-label">Export</div>
            </div>
        </div>

        <div class="row">
            <!-- Zone principale -->
            <div class="col-lg-8">
                <!-- Étape 1 : Upload -->
                <div class="card mb-4" id="uploadStep">
                    <div class="card-header bg-white">
                        <h4 class="mb-0"><i class="fas fa-*">fa-cloud-upload-alt</i> Étape 1 : Téléchargez votre fichier</h4>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="dropArea">
                            <div class="upload-icon">
                                <i class="fas fa-*">fa-image</i>
                            </div>
                            <h3>Déposez votre fichier ici</h3>
                            <p class="text-muted mb-3">Image, PDF ou CSV contenant des tableaux</p>
                            <p class="small text-muted">
                                Formats supportés: 
                                {% for ext in supported_formats.excel %}
                                <span class="badge bg-light text-dark">{{ ext }}</span>
                                {% endfor %}
                            </p>
                            <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf,.csv,.xlsx,.xls,.ods" style="display: none;">
                            <button class="btn btn-fa-exclamation-triangle btn-lg mt-2" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-*">fa-folder-open</i> Sélectionner un fichier
                            </button>
                        </div>
                        
                        <!-- Informations fichier -->
                        <div id="fileInfo" style="display: none;" class="mt-3">
                            <div class="alert alert-fa-exclamation-triangle">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-*">fa-check-circle</i>
                                        <strong id="fileName"></strong>
                                        <span id="fileSize" class="text-muted"></span>
                                        <span id="fileType" class="badge bg-info"></span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                        <i class="fas fa-*">fa-trash</i> Changer
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn btn-fa-exclamation-triangle w-100 py-3" onclick="detectTables()" id="detectBtn">
                                <i class="fas fa-*">fa-search</i> Détecter les tableaux
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Étape 2 : Détection -->
                <div class="card mb-4" id="detectionStep" style="display: none;">
                    <div class="card-header bg-white">
                        <h4 class="mb-0"><i class="fas fa-*">fa-search</i> Étape 2 : Détection des tableaux</h4>
                    </div>
                    <div class="card-body">
                        <div class="detection-results">
                            <h5><i class="fas fa-*">find_in_page</i> Analyse en cours...</h5>
                            <p>Recherche de structures tabulaires dans votre fichier</p>
                            
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-fa-exclamation-triangle" 
                                     id="detectionProgress" style="width: 0%"></div>
                            </div>
                            
                            <div id="detectionDetails">
                                <!-- Les résultats apparaîtront ici -->
                            </div>
                        </div>
                        
                        <!-- Prévisualisation du tableau -->
                        <div id="previewContainer" style="display: none;">
                            <h5 class="mt-4"><i class="fas fa-*">preview</i> Prévisualisation détectée</h5>
                            <div class="preview-container">
                                <table class="table-preview" id="tablePreview">
                                    <!-- Le tableau apparaîtra ici -->
                                </table>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-*">info</i>
                                <small>
                                    Si la détection n'est pas satisfaisante, ajustez les paramètres ci-dessous et réessayez.
                                </small>
                            </div>
                            
                            <button class="btn btn-outline-fa-exclamation-triangle" onclick="adjustDetection()">
                                <i class="fas fa-*">tune</i> Ajuster la détection
                            </button>
                            <button class="btn btn-fa-exclamation-triangle float-end" onclick="goToOptions()">
                                Continuer <i class="fas fa-*">arrow_forward</i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Étape 3 : Options -->
                <div class="card mb-4" id="optionsStep" style="display: none;">
                    <div class="card-header bg-white">
                        <h4 class="mb-0"><i class="fas fa-*">settings</i> Étape 3 : Options d'export</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Format de sortie -->
                            <div class="col-md-6 mb-4">
                                <h5><i class="fas fa-*">grid_on</i> Format Excel</h5>
                                <div class="format-options">
                                    <div class="format-option" onclick="selectFormat('xlsx')" id="formatXlsx">
                                        <i class="fas fa-*" style="font-size: 2rem;">grid_on</i>
                                        <div>.xlsx</div>
                                        <small>Excel moderne</small>
                                    </div>
                                    <div class="format-option" onclick="selectFormat('csv')" id="formatCsv">
                                        <i class="fas fa-*" style="font-size: 2rem;">table_rows</i>
                                        <div>.csv</div>
                                        <small>Texte simple</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Options OCR -->
                            <div class="col-md-6 mb-4">
                                <h5><i class="fas fa-*">text_fields</i> Reconnaissance de texte</h5>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="ocrEnabled" checked>
                                    <label class="form-check-label" for="ocrEnabled">
                                        <strong>Activer l'OCR</strong>
                                    </label>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Précision de détection</label>
                                    <select class="form-select" id="detectionAccuracy">
                                        <option value="high">Haute (lent)</option>
                                        <option value="medium" selected>Moyenne</option>
                                        <option value="low">Basse (rapide)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Options de structuration -->
                            <div class="col-md-6 mb-4">
                                <h5><i class="fas fa-*">account_tree</i> Structure des données</h5>
                                
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="detectHeaders" checked>
                                    <label class="form-check-label" for="detectHeaders">
                                        Détecter les en-têtes
                                    </label>
                                </div>
                                
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="mergeCells" checked>
                                    <label class="form-check-label" for="mergeCells">
                                        Fusionner les cellules similaires
                                    </label>
                                </div>
                                
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="detectFormulas">
                                    <label class="form-check-label" for="detectFormulas">
                                        Détecter les formules numériques
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Options de feuilles -->
                            <div class="col-md-6 mb-4">
                                <h5><i class="fas fa-*">layers</i> Organisation</h5>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nom de la feuille</label>
                                    <input type="text" class="form-control" id="sheetName" value="Données" placeholder="Nom de la feuille Excel">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Séparateur CSV</label>
                                    <select class="form-select" id="csvSeparator">
                                        <option value="," selected>Virgule (,)</option>
                                        <option value=";">Point-virgule (;)</option>
                                        <option value="\t">Tabulation</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-outline-fa-exclamation-triangle me-3" onclick="goToDetection()">
                                <i class="fas fa-*">fa-arrow-left</i> Retour
                            </button>
                            <button class="btn btn-fa-exclamation-triangle btn-lg px-5" onclick="exportToExcel()">
                                <i class="fas fa-*">file_download</i> Exporter vers Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Étape 4 : Export -->
                <div class="card" id="exportStep" style="display: none;">
                    <div class="card-body text-center">
                        <div class="spinner-border text-fa-exclamation-triangle" style="width: 5rem; height: 5rem;" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <h3 class="mt-4">Génération du fichier Excel...</h3>
                        <p id="exportStatus">Préparation des données</p>
                        
                        <div class="progress mt-4" style="height: 12px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-fa-exclamation-triangle" 
                                 id="exportProgress" style="width: 0%"></div>
                        </div>
                        
                        <div class="mt-4" id="exportResult" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-*">fa-check-circle</i>
                                <h4>Export réussi !</h4>
                                <p>Votre fichier Excel a été généré avec succès.</p>
                                <button class="btn btn-success" id="downloadBtn">
                                    <i class="fas fa-*">download</i> Télécharger
                                </button>
                                <button class="btn btn-outline-success ms-2" onclick="startNewConversion()">
                                    <i class="fas fa-*">refresh</i> Nouvelle conversion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations -->
                <div class="alert alert-info mt-4">
                    <i class="fas fa-*">info</i>
                    <div class="d-flex">
                        <div>
                            <strong>Capacités de détection :</strong>
                            <ul class="mb-0">
                                <li>Reconnaissance de tableaux dans les images et PDF</li>
                                <li>Extraction de données structurées</li>
                                <li>Support des CSV existants (conversion directe)</li>
                                <li>Gestion des cellules fusionnées</li>
                                <li>Taille max : {{ config.MAX_IMAGE_SIZE // (1024*1024) }} MB</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-fa-exclamation-triangle text-white">
                        <h5 class="mb-0"><i class="fas fa-*">fa-question-circle</i> Guide d'extraction</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6><i class="fas fa-*">table_view</i> Qu'est-ce qui est détecté ?</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-* text-success" style="font-size: 1rem;">check</i> Bordures de tableau</li>
                                <li class="mb-2"><i class="fas fa-* text-success" style="font-size: 1rem;">check</i> Alignements de texte</li>
                                <li class="mb-2"><i class="fas fa-* text-success" style="font-size: 1rem;">check</i> Grilles régulières</li>
                                <li><i class="fas fa-* text-success" style="font-size: 1rem;">check</i> En-têtes de colonnes</li>
                            </ul>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-4">
                            <h6><i class="fas fa-*">fa-exclamation-triangle</i> Pour de meilleurs résultats</h6>
                            <div class="alert alert-fa-exclamation-triangle small">
                                <i class="fas fa-*">lightbulb</i>
                                Utilisez des images avec :
                                <ul class="mb-0 mt-1">
                                    <li>Tableaux bien cadrés</li>
                                    <li>Bordures visibles</li>
                                    <li>Texte lisible</li>
                                    <li>Contraste élevé</li>
                                </ul>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-4">
                            <h6><i class="fas fa-*">speed</i> Performances</h6>
                            <p class="small mb-1"><strong>Complexité élevée :</strong> Images floues, bordures invisibles</p>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar bg-danger" style="width: 80%"></div>
                            </div>
                            
                            <p class="small mb-1"><strong>Complexité moyenne :</strong> PDF avec tableaux</p>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar bg-fa-exclamation-triangle" style="width: 60%"></div>
                            </div>
                            
                            <p class="small mb-1"><strong>Simple :</strong> CSV, images claires</p>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 30%"></div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div>
                            <h6><i class="fas fa-*">format_list_bulleted</i> Formats de sortie</h6>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-* text-success me-2">grid_on</i>
                                <div>
                                    <strong>.xlsx</strong>
                                    <small class="d-block">Excel moderne avec mise en forme</small>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-* text-info me-2">table_rows</i>
                                <div>
                                    <strong>.csv</strong>
                                    <small class="d-block">Texte simple, compatible universel</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Votre JavaScript existant -->
    ...
    {% endblock %}
    
    {% block scripts %}
    <script>
        let selectedFile = null;
        let detectedTables = [];
        let selectedFormat = 'xlsx';
        const maxSize = {{ config.MAX_IMAGE_SIZE }};
        
        // Initialiser l'étape active
        updateSteps(1);
        selectFormat('xlsx');
        
        // Gestion du drag & drop
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        
        // Gérer le drag & drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('dragover');
        }
        
        function unhighlight() {
            dropArea.classList.remove('dragover');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files: [files[0]] } });
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            
            if (!file) return;
            
            // Vérifier la taille
            if (file.size > maxSize) {
                alert(`Le fichier dépasse la taille maximale de ${maxSize/(1024*1024)} MB.`);
                return;
            }
            
            // Vérifier l'extension
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            const allowedExts = {{ config.SUPPORTED_IMAGE_FORMATS.excel|tojson }};
            if (!allowedExts.includes(ext)) {
                alert(`Format non supporté. Formats acceptés: ${allowedExts.join(', ')}`);
                return;
            }
            
            selectedFile = file;
            updateFileDisplay();
        }
        
        function updateFileDisplay() {
            document.getElementById('fileName').textContent = selectedFile.name;
            document.getElementById('fileSize').textContent = ` (${formatFileSize(selectedFile.size)})`;
            
            // Déterminer le type
            let fileType = 'Image';
            if (selectedFile.name.toLowerCase().endsWith('.pdf')) fileType = 'PDF';
            if (selectedFile.name.toLowerCase().endsWith('.csv')) fileType = 'CSV';
            if (selectedFile.name.toLowerCase().endsWith('.xlsx') || selectedFile.name.toLowerCase().endsWith('.xls')) fileType = 'Excel';
            if (selectedFile.name.toLowerCase().endsWith('.ods')) fileType = 'OpenDocument';
            
            document.getElementById('fileType').textContent = fileType;
            fileInfo.style.display = 'block';
        }
        
        function clearFile() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            document.getElementById('uploadStep').style.display = 'block';
            document.getElementById('detectionStep').style.display = 'none';
            document.getElementById('optionsStep').style.display = 'none';
            updateSteps(1);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Gestion des étapes
        function updateSteps(activeStep) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById('step' + i);
                const stepNum = step.querySelector('.step-number');
                
                if (i < activeStep) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                    stepNum.textContent = '✓';
                } else if (i === activeStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                    stepNum.textContent = i;
                } else {
                    step.classList.remove('active', 'completed');
                    stepNum.textContent = i;
                }
            }
        }
        
        function selectFormat(format) {
            selectedFormat = format;
            document.getElementById('formatXlsx').classList.remove('selected');
            document.getElementById('formatCsv').classList.remove('selected');
            document.getElementById('format' + format.charAt(0).toUpperCase() + format.slice(1)).classList.add('selected');
        }
        
        async function detectTables() {
            if (!selectedFile) return;
            
            // Passer à l'étape 2
            document.getElementById('uploadStep').style.display = 'none';
            document.getElementById('detectionStep').style.display = 'block';
            updateSteps(2);
            
            const progressBar = document.getElementById('detectionProgress');
            const detectionDetails = document.getElementById('detectionDetails');
            
            try {
                // Simuler la détection
                progressBar.style.width = '0%';
                detectionDetails.innerHTML = `
                    <div class="detected-table">
                        <h6><i class="fas fa-*">hourglass_empty</i> Analyse initiale...</h6>
                        <p>Examen de la structure du document</p>
                    </div>
                `;
                
                // Simuler la progression
                const steps = [
                    { text: 'Analyse de la structure', progress: 20 },
                    { text: 'Détection des bordures', progress: 40 },
                    { text: 'Identification des cellules', progress: 60 },
                    { text: 'Extraction du texte', progress: 80 },
                    { text: 'Validation des données', progress: 100 }
                ];
                
                for (const step of steps) {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    progressBar.style.width = step.progress + '%';
                    
                    detectionDetails.innerHTML = `
                        <div class="detected-table">
                            <h6><i class="fas fa-*">fa-search</i> ${step.text}</h6>
                            <p>Progression : ${step.progress}%</p>
                        </div>
                    `;
                }
                
                // Afficher les résultats simulés
                detectedTables = [
                    {
                        name: 'Tableau Principal',
                        rows: 10,
                        cols: 5,
                        confidence: 92,
                        data: [
                            ['Nom', 'Âge', 'Ville', 'Salaire', 'Département'],
                            ['Jean Dupont', '32', 'Paris', '45000', 'IT'],
                            ['Marie Martin', '28', 'Lyon', '38000', 'RH'],
                            ['Pierre Bernard', '45', 'Marseille', '52000', 'Finance'],
                            ['Sophie Petit', '31', 'Toulouse', '41000', 'Marketing']
                        ]
                    },
                    {
                        name: 'Données Secondaires',
                        rows: 4,
                        cols: 3,
                        confidence: 78,
                        data: [
                            ['Produit', 'Quantité', 'Prix'],
                            ['Ordinateur', '15', '1200'],
                            ['Souris', '45', '25'],
                            ['Clavier', '30', '45']
                        ]
                    }
                ];
                
                // Afficher les résultats
                displayDetectionResults();
                
            } catch (error) {
                detectionDetails.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-*">error</i>
                        Erreur lors de la détection : ${error.message}
                    </div>
                `;
            }
        }
        
        function displayDetectionResults() {
            const detectionDetails = document.getElementById('detectionDetails');
            const previewContainer = document.getElementById('previewContainer');
            const tablePreview = document.getElementById('tablePreview');
            
            // Afficher le résumé
            detectionDetails.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-*">fa-check-circle</i>
                    <strong>Détection réussie !</strong>
                    <p>${detectedTables.length} tableau(x) détecté(s)</p>
                </div>
            `;
            
            // Afficher chaque tableau détecté
            detectedTables.forEach((table, index) => {
                detectionDetails.innerHTML += `
                    <div class="detected-table">
                        <h6><i class="fas fa-*">fa-table</i> ${table.name}</h6>
                        <p>${table.rows} lignes × ${table.cols} colonnes | Confiance : ${table.confidence}%</p>
                    </div>
                `;
            });
            
            // Afficher la prévisualisation du premier tableau
            if (detectedTables.length > 0) {
                const firstTable = detectedTables[0];
                tablePreview.innerHTML = '';
                
                // En-têtes
                const headerRow = document.createElement('tr');
                firstTable.data[0].forEach(cell => {
                    const th = document.createElement('th');
                    th.textContent = cell;
                    headerRow.appendChild(th);
                });
                tablePreview.appendChild(headerRow);
                
                // Données
                for (let i = 1; i < Math.min(6, firstTable.data.length); i++) {
                    const row = document.createElement('tr');
                    firstTable.data[i].forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        row.appendChild(td);
                    });
                    tablePreview.appendChild(row);
                }
                
                if (firstTable.data.length > 6) {
                    const moreRow = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = firstTable.cols;
                    td.textContent = `... et ${firstTable.data.length - 6} lignes supplémentaires`;
                    td.style.textAlign = 'center';
                    td.style.fontStyle = 'italic';
                    moreRow.appendChild(td);
                    tablePreview.appendChild(moreRow);
                }
                
                previewContainer.style.display = 'block';
            }
        }
        
        function adjustDetection() {
            // Ici, vous pourriez implémenter une interface pour ajuster les paramètres de détection
            alert('Fonctionnalité d\'ajustement à implémenter');
        }
        
        function goToOptions() {
            document.getElementById('detectionStep').style.display = 'none';
            document.getElementById('optionsStep').style.display = 'block';
            updateSteps(3);
        }
        
        function goToDetection() {
            document.getElementById('optionsStep').style.display = 'none';
            document.getElementById('detectionStep').style.display = 'block';
            updateSteps(2);
        }
        
        async function exportToExcel() {
            if (!selectedFile || detectedTables.length === 0) return;
            
            // Passer à l'étape 4
            document.getElementById('optionsStep').style.display = 'none';
            document.getElementById('exportStep').style.display = 'block';
            updateSteps(4);
            
            const progressBar = document.getElementById('exportProgress');
            const exportStatus = document.getElementById('exportStatus');
            const exportResult = document.getElementById('exportResult');
            
            try {
                // Simuler la progression
                const steps = [
                    { text: 'Préparation des données', progress: 10 },
                    { text: 'Génération des feuilles', progress: 30 },
                    { text: 'Application du formatage', progress: 50 },
                    { text: 'Encodage du fichier', progress: 80 },
                    { text: 'Finalisation', progress: 100 }
                ];
                
                for (const step of steps) {
                    await new Promise(resolve => setTimeout(resolve, 600));
                    progressBar.style.width = step.progress + '%';
                    exportStatus.textContent = step.text;
                }
                
                // Afficher le résultat
                exportResult.style.display = 'block';
                
                // Configurer le bouton de téléchargement
                document.getElementById('downloadBtn').onclick = async () => {
                    try {
                        // Préparer les données du formulaire
                        const formData = new FormData();
                        formData.append('file', selectedFile);
                        formData.append('detect_tables', 'true');
                        formData.append('language', 'fra');
                        formData.append('format', selectedFormat);
                        formData.append('sheet_name', document.getElementById('sheetName').value);
                        formData.append('csv_separator', document.getElementById('csvSeparator').value);
                        formData.append('ocr_enabled', document.getElementById('ocrEnabled').checked ? 'true' : 'false');
                        
                        // Envoyer la requête
                        const response = await fetch("{{ url_for('conversion.image_to_excel') }}", {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Erreur lors de la conversion');
                        }
                        
                        // Télécharger le fichier
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `tableaux_${new Date().toISOString().slice(0,10)}.${selectedFormat}`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        showToast('Fichier Excel téléchargé avec succès!', 'success');
                        
                    } catch (error) {
                        showToast('Erreur: ' + error.message, 'error');
                    }
                };
                
            } catch (error) {
                exportResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-*">error</i>
                        <h4>Erreur lors de l'export</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-outline-danger" onclick="goToOptions()">
                            <i class="fas fa-*">fa-arrow-left</i> Retour
                        </button>
                    </div>
                `;
            }
        }
        
        function startNewConversion() {
            clearFile();
            document.getElementById('exportStep').style.display = 'none';
            document.getElementById('uploadStep').style.display = 'block';
            updateSteps(1);
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast show position-fixed bottom-0 end-0 m-3 bg-${type === 'success' ? 'success' : 'danger'} text-white`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
    {% endblock %}
</body>

</html>

