{% extends "base.html" %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
.upload-area {
    border: 3px dashed #FF9800;
    border-radius: 15px;
    padding: 3rem 1rem;
    text-align: center;
    background: #f8f9fa;
    transition: 0.3s;
    cursor: pointer;
}

.upload-area:hover,
.upload-area.dragover {
    background: #fff3e0;
}

.preview-container {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 1rem;
    background: white;
    margin-top: 1.5rem;
    max-height: 400px;
    overflow: auto;
}

.step-indicator {
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.step.active .step-number { background: #FF9800; color:white; }
.step.completed .step-number { background: #198754; color:white; }

.format-option{
    border:2px solid #dee2e6;
    padding:1rem;
    border-radius:10px;
    cursor:pointer;
    text-align:center;
}

.format-option.selected{
    border-color:#FF9800;
    background:#fff3e0;
}
</style>
{% endblock %}


{% block content %}
<div class="container py-4">

<a href="{{ url_for('conversion.index') }}" class="btn btn-outline-primary mb-3">
    <i class="fas fa-arrow-left"></i> Retour aux conversions
</a>

<h1 class="mb-3">
    <i class="fas fa-table"></i> Image vers Excel
</h1>

<!-- Steps -->
<div class="step-indicator">
    {% for i in range(1,5) %}
    <div class="step" id="step{{i}}">
        <div class="step-number">{{i}}</div>
    </div>
    {% endfor %}
</div>


<!-- STEP 1 -->
<div class="card" id="uploadStep">
    <div class="card-body">

        <div class="upload-area" id="dropArea">
            <i class="fas fa-image fa-3x text-warning mb-3"></i>
            <h4>Déposez votre fichier</h4>

            <input type="file"
                   id="fileInput"
                   class="d-none"
                   accept=".jpg,.jpeg,.png,.pdf">

            <button class="btn btn-warning mt-3"
                    onclick="fileInput.click()">
                <i class="fas fa-folder-open"></i>
                Sélectionner
            </button>
        </div>

        <div id="fileInfo" class="alert alert-success mt-3 d-none"></div>

        <button id="detectBtn"
                class="btn btn-warning w-100 mt-3 d-none">
            Détecter les tableaux
        </button>

    </div>
</div>


<!-- STEP 2 -->
<div class="card mt-4 d-none" id="detectionStep">
    <div class="card-body text-center">
        <div class="spinner-border text-warning"></div>
        <p class="mt-3">Analyse du document...</p>

        <div class="progress">
            <div id="detectionProgress"
                 class="progress-bar progress-bar-striped progress-bar-animated"
                 style="width:0%"></div>
        </div>

        <div id="previewContainer" class="preview-container d-none">
            <table class="table table-bordered" id="tablePreview"></table>
        </div>

        <button class="btn btn-warning mt-3 d-none"
                id="optionsBtn">
            Continuer
        </button>
    </div>
</div>


<!-- STEP 3 -->
<div class="card mt-4 d-none" id="optionsStep">
    <div class="card-body">

        <h5>Format</h5>

        <div class="d-flex gap-3 mb-4">
            <div class="format-option" id="formatXlsx">.xlsx</div>
            <div class="format-option" id="formatCsv">.csv</div>
        </div>

        <button class="btn btn-warning w-100"
                id="exportBtn">
            Exporter
        </button>

    </div>
</div>


<!-- STEP 4 -->
<div class="card mt-4 d-none" id="exportStep">
    <div class="card-body text-center">

        <div class="spinner-border text-warning"></div>
        <h4 class="mt-3">Génération du fichier...</h4>

        <div id="exportResult" class="d-none mt-4">
            <button id="downloadBtn"
                    class="btn btn-success">
                Télécharger
            </button>
        </div>

    </div>
</div>

</div>
{% endblock %}



{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

let selectedFile=null;
let selectedFormat='xlsx';

const maxSize = {{ config.MAX_IMAGE_SIZE | tojson }};

const dropArea=document.getElementById('dropArea');
const fileInput=document.getElementById('fileInput');
const fileInfo=document.getElementById('fileInfo');
const detectBtn=document.getElementById('detectBtn');


// STEP helper
function updateSteps(n){
    document.querySelectorAll('.step').forEach((s,i)=>{
        s.classList.remove('active','completed');
        if(i+1<n) s.classList.add('completed');
        if(i+1===n) s.classList.add('active');
    });
}

updateSteps(1);


// Drag & drop
['dragover','drop'].forEach(evt=>{
    dropArea.addEventListener(evt,e=>{
        e.preventDefault();
    });
});

dropArea.addEventListener('drop',e=>{
    fileInput.files=e.dataTransfer.files;
    handleFile();
});

fileInput.addEventListener('change',handleFile);


function handleFile(){

const file=fileInput.files[0];
if(!file) return;

if(file.size>maxSize){
    alert("Fichier trop volumineux");
    return;
}

selectedFile=file;

fileInfo.innerHTML=
`<strong>${file.name}</strong> (${(file.size/1024/1024).toFixed(2)} MB)`;

fileInfo.classList.remove('d-none');
detectBtn.classList.remove('d-none');

}


// Detection simulation
detectBtn.onclick=async ()=>{

updateSteps(2);

document.getElementById('detectionStep').classList.remove('d-none');

const bar=document.getElementById('detectionProgress');

for(let i=0;i<=100;i+=20){
    bar.style.width=i+'%';
    await new Promise(r=>setTimeout(r,400));
}

// fake preview
const preview=document.getElementById('previewContainer');
const table=document.getElementById('tablePreview');

table.innerHTML=`
<tr><th>Nom</th><th>Ville</th></tr>
<tr><td>Jean</td><td>Paris</td></tr>
<tr><td>Marie</td><td>Lyon</td></tr>
`;

preview.classList.remove('d-none');
document.getElementById('optionsBtn').classList.remove('d-none');

};

document.getElementById('optionsBtn').onclick=()=>{
updateSteps(3);
document.getElementById('optionsStep').classList.remove('d-none');
};


// format
document.getElementById('formatXlsx').onclick=()=>{
selectedFormat='xlsx';
toggleFormat();
};

document.getElementById('formatCsv').onclick=()=>{
selectedFormat='csv';
toggleFormat();
};

function toggleFormat(){
document.querySelectorAll('.format-option')
.forEach(el=>el.classList.remove('selected'));

document.getElementById(
selectedFormat==='xlsx'?'formatXlsx':'formatCsv'
).classList.add('selected');
}

toggleFormat();


// Export
document.getElementById('exportBtn').onclick=async()=>{

updateSteps(4);
document.getElementById('exportStep').classList.remove('d-none');

await new Promise(r=>setTimeout(r,1500));

document.getElementById('exportResult').classList.remove('d-none');

document.getElementById('downloadBtn').onclick=async()=>{

const formData=new FormData();
formData.append('file',selectedFile);
formData.append('format',selectedFormat);

const res=await fetch("{{ url_for('conversion.image_to_excel') }}",{
method:'POST',
body:formData
});

const blob=await res.blob();
const url=window.URL.createObjectURL(blob);

const a=document.createElement('a');
a.href=url;
a.download=`export.${selectedFormat}`;
a.click();

};

};

});
</script>
{% endblock %}
