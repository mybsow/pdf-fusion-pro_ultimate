{% extends "conversion/conversion_base.html" %}

{% block title %}{{ _('Image vers Excel - Convertisseur') }}{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload -->
<div id="step1Content">
    <div class="text-center mb-4">
        <i class="fas fa-image upload-icon" style="color: #217346;"></i>
        <h3>{{ _('Téléchargez votre image ou PDF') }}</h3>
        <p class="text-muted">{{ _('Extrayez les tableaux de vos documents en feuilles Excel') }}</p>
    </div>

    <!-- Zone d'upload avec UploadManager -->
    <div id="imageExcelUploadZone" 
         class="upload-zone-pro upload-zone" 
         data-info-id="fileInfo"
         data-btn-id="convertBtn"
         style="cursor: pointer;">
        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
        <h4>{{ _('Glissez-déposez votre fichier ici') }}</h4>
        <p class="text-muted">{{ _('ou') }}</p>
        <input type="file" class="file-input" accept=".jpg,.jpeg,.png,.bmp,.tiff,.tif,.webp,.pdf" style="display: none;">
        <p class="text-muted small mt-3">
            <i class="fas fa-info-circle"></i> 
            {{ _('Formats acceptés : JPG, PNG, BMP, TIFF, WEBP, PDF (jusqu\'à 50MB)') }}
        </p>
    </div>

    <!-- Liste des fichiers -->
    <div id="fileInfo" class="file-list mt-4"></div>
    <div id="imageExcelUploadZoneThumbnails" class="upload-thumbnails d-flex flex-wrap gap-2 mt-3"></div>

    <!-- Options de détection de tableaux -->
    <div class="file-info-card mt-4">
        <h5 class="mb-3">
            <i class="fas fa-cog me-2"></i>{{ _('Options d\'extraction') }}
        </h5>
        
        <div class="row g-4">
            <div class="col-md-6">
                <label class="form-label fw-bold mb-3">
                    <i class="fas fa-cogs me-1"></i>{{ _('Mode d\'extraction') }}
                </label>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" 
                           name="extractionMode" 
                           id="mode_auto" 
                           value="auto" 
                           checked>
                    <label class="form-check-label" for="mode_auto">
                        <strong>{{ _('Automatique') }}</strong>
                        <small class="d-block text-muted">{{ _('Détection intelligente des tableaux') }}</small>
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" 
                           name="extractionMode" 
                           id="mode_grid" 
                           value="grid">
                    <label class="form-check-label" for="mode_grid">
                        <strong>{{ _('Grille') }}</strong>
                        <small class="d-block text-muted">{{ _('Extraction par grille fixe') }}</small>
                    </label>
                </div>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-bold mb-3">
                    <i class="fas fa-filter me-1"></i>{{ _('Options') }}
                </label>
                
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" 
                           id="detectHeaders" 
                           checked>
                    <label class="form-check-label" for="detectHeaders">
                        <strong>{{ _('Détecter les en-têtes') }}</strong>
                    </label>
                </div>
                
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" 
                           id="mergeCells" 
                           checked>
                    <label class="form-check-label" for="mergeCells">
                        <strong>{{ _('Fusionner les cellules') }}</strong>
                    </label>
                </div>
            </div>

            <div class="col-md-6">
                <label for="ocrAccuracy" class="form-label fw-bold">{{ _('Précision OCR') }}</label>
                <select class="form-select" id="ocrAccuracy">
                    <option value="high">{{ _('Haute (plus lent)') }}</option>
                    <option value="medium" selected>{{ _('Moyenne (équilibré)') }}</option>
                    <option value="low">{{ _('Basse (plus rapide)') }}</option>
                </select>
            </div>
            
            <div class="col-md-6">
                <label for="outputFormat" class="form-label fw-bold">{{ _('Format de sortie') }}</label>
                <select class="form-select" id="outputFormat">
                    <option value="xlsx">{{ _('Excel (XLSX)') }}</option>
                    <option value="csv">CSV</option>
                    <option value="json">JSON</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Statistiques de détection (affichées après upload) -->
    <div id="tableStats" class="alert alert-info mt-4" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <div><i class="fas fa-table me-2"></i><span id="tablesCount">0</span> {{ _('tableau(x) détecté(s)') }}</div>
            <div><i class="fas fa-th me-2"></i><span id="cellsCount">0</span> {{ _('cellule(s)') }}</div>
            <div><i class="fas fa-check-circle me-2"></i>{{ _('Prêt pour extraction') }}</div>
        </div>
    </div>

    <!-- Bouton de conversion -->
    <div class="text-center mt-4">
        <button class="btn btn-success btn-lg px-5" id="convertBtn" onclick="startConversion()" disabled>
            <i class="fas fa-search me-2"></i>{{ _('Extraire les tableaux') }}
        </button>
        <button class="btn btn-outline-secondary btn-lg ms-2" onclick="resetConversion()">
            <i class="fas fa-redo me-2"></i>{{ _('Réinitialiser') }}
        </button>
    </div>
</div>

<!-- Étape 2: Analyse en cours -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-cog fa-spin fa-4x text-primary"></i>
        </div>
        
        <h3 class="mb-4">{{ _('Analyse des tableaux en cours') }}</h3>
        <p class="text-muted mb-4" id="analysisMessage">
            {{ _('Détection des structures tabulaires...') }}
        </p>
        
        <div class="progress-container mx-auto" style="max-width: 500px;">
            <div class="progress-bar" id="analysisProgress" style="width: 0%;"></div>
        </div>
        
        <div class="row mt-5 g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Tableaux détectés') }}</h6>
                        <div class="display-6 text-primary" id="detectedTables">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Cellules extraites') }}</h6>
                        <div class="display-6 text-success" id="detectedCells">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Confiance') }}</h6>
                        <div class="display-6 text-warning" id="detectionConfidence">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Étape 3: Résultat et téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation">
            <i class="fas fa-file-excel"></i>
        </div>
        
        <h3 class="mb-3">{{ _('Extraction terminée !') }}</h3>
        <p class="text-muted mb-4">
            {{ _('Votre fichier Excel est prêt à être téléchargé') }}
        </p>
        
        <!-- Aperçu des données -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h6 class="mb-3"><i class="fas fa-table me-1"></i>{{ _('Aperçu des données') }}</h6>
                <div class="table-responsive">
                    <table class="table table-hover table-sm" id="dataPreview">
                        <thead id="previewHeader"></thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
                <div class="mt-3 text-end">
                    <small class="text-muted" id="totalRows">0 {{ _('lignes extraites') }}</small>
                </div>
            </div>
        </div>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <a href="#" class="btn btn-success btn-lg px-5" id="downloadLink">
                <i class="fas fa-download me-2"></i>{{ _('Télécharger Excel') }}
            </a>
            
            <button class="btn btn-outline-primary btn-lg px-5" onclick="resetConversion()">
                <i class="fas fa-redo me-2"></i>{{ _('Nouvelle extraction') }}
            </button>
        </div>
    </div>
</div>

<script>
let downloadUrl = null;

function startConversion() {
    const uploadManager = window.uploadManagers['imageExcelUploadZone'];
    if (!uploadManager || uploadManager.getFiles().length === 0) {
        showError('{{ _("Veuillez sélectionner un fichier") }}');
        return;
    }

    const formData = new FormData();
    formData.append('file', uploadManager.getFiles()[0]);
    formData.append('extractionMode', document.querySelector('input[name="extractionMode"]:checked').value);
    formData.append('detectHeaders', document.getElementById('detectHeaders').checked);
    formData.append('mergeCells', document.getElementById('mergeCells').checked);
    formData.append('ocrAccuracy', document.getElementById('ocrAccuracy').value);
    formData.append('outputFormat', document.getElementById('outputFormat').value);

    // Passer à l'étape 2
    updateStep(2);
    
    // Simuler la progression de l'analyse
    simulateAnalysis();
    
    // Envoyer la requête
    fetch('{{ url_for("conversion.universal_converter", conversion_type="image-en-excel") }}', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        if (response.ok) {
            const blob = await response.blob();
            downloadUrl = window.URL.createObjectURL(blob);
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = '{{ _("extraction.xlsx") }}';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (match && match[1]) {
                    filename = match[1].replace(/['"]/g, '');
                }
            }
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            
            // Simuler l'aperçu des données
            simulateDataPreview();
            
            updateStep(3);
        } else {
            const error = await response.text();
            showError('{{ _("Erreur lors de l\'extraction :") }} ' + error);
            updateStep(1);
        }
    })
    .catch(error => {
        showError('{{ _("Erreur :") }} ' + error.message);
        updateStep(1);
    });
}

function simulateAnalysis() {
    let progress = 0;
    const progressBar = document.getElementById('analysisProgress');
    const analysisMessage = document.getElementById('analysisMessage');
    const detectedTables = document.getElementById('detectedTables');
    const detectedCells = document.getElementById('detectedCells');
    const detectionConfidence = document.getElementById('detectionConfidence');
    
    const steps = [
        { percent: 20, message: '{{ _("Prétraitement de l\'image...") }}', tables: 0, cells: 0, confidence: 10 },
        { percent: 40, message: '{{ _("Détection des contours...") }}', tables: 1, cells: 50, confidence: 30 },
        { percent: 60, message: '{{ _("Identification des lignes...") }}', tables: 1, cells: 120, confidence: 50 },
        { percent: 80, message: '{{ _("Extraction du contenu...") }}', tables: 2, cells: 250, confidence: 70 },
        { percent: 95, message: '{{ _("Structuration des données...") }}', tables: 3, cells: 450, confidence: 85 },
        { percent: 100, message: '{{ _("Finalisation...") }}', tables: 3, cells: 520, confidence: 92 }
    ];
    
    let stepIndex = 0;
    
    function updateProgress() {
        if (stepIndex < steps.length) {
            const step = steps[stepIndex];
            progressBar.style.width = step.percent + '%';
            analysisMessage.textContent = step.message;
            detectedTables.textContent = step.tables;
            detectedCells.textContent = step.cells;
            detectionConfidence.textContent = step.confidence + '%';
            
            stepIndex++;
            setTimeout(updateProgress, 800);
        }
    }
    
    updateProgress();
}

function simulateDataPreview() {
    const sampleData = {
        headers: ['{{ _("Nom") }}', '{{ _("Prénom") }}', '{{ _("Email") }}', '{{ _("Téléphone") }}', '{{ _("Ville") }}'],
        rows: [
            ['Martin', 'Jean', 'jean.martin@email.com', '01 23 45 67 89', 'Paris'],
            ['Dubois', 'Marie', 'marie.dubois@email.com', '06 12 34 56 78', 'Lyon'],
            ['Lambert', 'Pierre', 'pierre.lambert@email.com', '07 89 01 23 45', 'Marseille'],
            ['Bernard', 'Sophie', 'sophie.bernard@email.com', '02 34 56 78 90', 'Toulouse'],
            ['Petit', 'Thomas', 'thomas.petit@email.com', '03 45 67 89 01', 'Nice']
        ]
    };
    
    const header = document.getElementById('previewHeader');
    const body = document.getElementById('previewBody');
    const totalRows = document.getElementById('totalRows');
    
    header.innerHTML = '<tr>' + sampleData.headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
    body.innerHTML = sampleData.rows.map(row => 
        '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
    ).join('');
    
    totalRows.textContent = '25 {{ _("lignes extraites") }}';
}

function resetConversion() {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
        downloadUrl = null;
    }
    
    const uploadManager = window.uploadManagers['imageExcelUploadZone'];
    if (uploadManager) {
        while (uploadManager.getFiles().length > 0) {
            uploadManager.removeFile(0);
        }
    }
    
    document.getElementById('tableStats').style.display = 'none';
    updateStep(1);
}

// Mise à jour du bouton et des stats quand un fichier est sélectionné
document.addEventListener('DOMContentLoaded', function() {
    const uploadManager = window.uploadManagers?.['imageExcelUploadZone'];
    
    if (uploadManager) {
        const originalHandleFiles = uploadManager.handleFiles;
        uploadManager.handleFiles = function(fileList) {
            originalHandleFiles.call(this, fileList);
            const convertBtn = document.getElementById('convertBtn');
            convertBtn.disabled = this.getFiles().length === 0;
            
            // Afficher les stats simulées
            if (this.getFiles().length > 0) {
                document.getElementById('tableStats').style.display = 'block';
                const file = this.getFiles()[0];
                const tables = Math.floor(file.size / (1024 * 1024)) + 1;
                const cells = tables * 50;
                document.getElementById('tablesCount').textContent = tables;
                document.getElementById('cellsCount').textContent = cells;
            } else {
                document.getElementById('tableStats').style.display = 'none';
            }
        };
        
        const originalRemoveFile = uploadManager.removeFile;
        uploadManager.removeFile = function(index) {
            originalRemoveFile.call(this, index);
            const convertBtn = document.getElementById('convertBtn');
            convertBtn.disabled = this.getFiles().length === 0;
            
            if (this.getFiles().length === 0) {
                document.getElementById('tableStats').style.display = 'none';
            }
        };
    }
});

window.addEventListener('beforeunload', () => {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
    }
});
</script>
{% endblock %}