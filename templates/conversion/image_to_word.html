{% extends "conversion/conversion_base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload -->
<div id="step1Content">
    <div class="text-center mb-4">
        <i class="fas fa-file-word upload-icon" style="color: #2b579a;"></i>
        <h3>{{ _('Extrayez le texte de vos images') }}</h3>
        <p class="text-muted">{{ _('Convertissez images et PDF en documents Word éditables avec OCR') }}</p>
    </div>

    <!-- Zone d'upload avec UploadManager (unique) -->
    <div id="imageWordUploadZone" 
         class="upload-zone-pro upload-zone" 
         data-info-id="fileInfo"
         data-btn-id="convertBtn"
         style="cursor: pointer;">
        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
        <h4>{{ _('Glissez-déposez vos fichiers ici') }}</h4>
        <p class="text-muted">{{ _('ou') }}</p>
        <input type="file" class="file-input" accept=".jpg,.jpeg,.png,.bmp,.tiff,.tif,.webp,.pdf" style="display: none;">
        <p class="text-muted small mt-3">
            <i class="fas fa-info-circle"></i> 
            {{ _('Formats acceptés : JPG, PNG, BMP, TIFF, WEBP, PDF (jusqu\'à 50MB)') }}
        </p>
    </div>

    <!-- Liste des fichiers et miniatures -->
    <div id="fileInfo" class="file-list mt-4"></div>
    <div id="imageWordUploadZoneThumbnails" class="upload-thumbnails d-flex flex-wrap gap-2 mt-3"></div>

    <!-- Options OCR avancées -->
    <div class="file-info-card mt-4">
        <h5 class="mb-4">
            <i class="fas fa-robot me-2"></i>{{ _('Paramètres OCR avancés') }}
        </h5>
        
        <div class="row g-4">
            <div class="col-md-6">
                <label class="form-label fw-bold mb-3">
                    <i class="fas fa-language me-1"></i>{{ _('Langues de reconnaissance') }}
                </label>
                <div class="row">
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="languages" value="fra" id="lang_fra" checked>
                            <label class="form-check-label" for="lang_fra">{{ _('Français') }}</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="languages" value="eng" id="lang_eng">
                            <label class="form-check-label" for="lang_eng">{{ _('Anglais') }}</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="languages" value="spa" id="lang_spa">
                            <label class="form-check-label" for="lang_spa">{{ _('Espagnol') }}</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="languages" value="deu" id="lang_deu">
                            <label class="form-check-label" for="lang_deu">{{ _('Allemand') }}</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="languages" value="ita" id="lang_ita">
                            <label class="form-check-label" for="lang_ita">{{ _('Italien') }}</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="languages" value="por" id="lang_por">
                            <label class="form-check-label" for="lang_por">{{ _('Portugais') }}</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-4">
                    <label class="form-label fw-bold">{{ _('Niveau de confiance OCR') }}</label>
                    <input type="range" class="form-range" id="confidenceLevel" min="0" max="100" value="70">
                    <div class="d-flex justify-content-between small">
                        <span>{{ _('Bas (plus de texte)') }}</span>
                        <span id="confidenceValue">70%</span>
                        <span>{{ _('Haut (plus précis)') }}</span>
                    </div>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="preserveLayout" checked>
                    <label class="form-check-label" for="preserveLayout">
                        <strong>{{ _('Conserver la mise en page') }}</strong>
                        <small class="d-block text-muted">{{ _('Maintient les paragraphes et colonnes') }}</small>
                    </label>
                </div>
            </div>

            <div class="col-md-6">
                <label for="preprocessing" class="form-label fw-bold">{{ _('Prétraitement d\'image') }}</label>
                <select class="form-select" id="preprocessing">
                    <option value="none">{{ _('Aucun') }}</option>
                    <option value="grayscale">{{ _('Niveaux de gris') }}</option>
                    <option value="binarization" selected>{{ _('Binarisation (recommandé)') }}</option>
                    <option value="denoise">{{ _('Réduction du bruit') }}</option>
                    <option value="skew">{{ _('Correction inclinaison') }}</option>
                </select>
            </div>
            
            <div class="col-md-6">
                <label for="outputFormat" class="form-label fw-bold">{{ _('Format de sortie') }}</label>
                <select class="form-select" id="outputFormat">
                    <option value="docx" selected>{{ _('DOCX (Word moderne)') }}</option>
                    <option value="doc">{{ _('DOC (Word ancien)') }}</option>
                    <option value="txt">{{ _('TXT (texte brut)') }}</option>
                    <option value="rtf">{{ _('RTF (format riche)') }}</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Bouton de conversion -->
    <div class="text-center mt-4">
        <button class="btn btn-primary btn-lg px-5" id="convertBtn" onclick="startConversion()" disabled>
            <i class="fas fa-magic me-2"></i>{{ _('Extraire et convertir en Word') }}
        </button>
        <button class="btn btn-outline-secondary btn-lg ms-2" onclick="resetConversion()">
            <i class="fas fa-redo me-2"></i>{{ _('Réinitialiser') }}
        </button>
    </div>
</div>

<!-- Étape 2: Conversion en cours -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-cog fa-spin fa-4x text-primary"></i>
        </div>
        
        <h3 class="mb-4">{{ _('Extraction OCR en cours') }}</h3>
        <p class="text-muted mb-4" id="ocrMessage">
            {{ _('Analyse du document et reconnaissance de texte...') }}
        </p>
        
        <div class="progress-container mx-auto" style="max-width: 500px;">
            <div class="progress-bar" id="conversionProgress" style="width: 0%;"></div>
        </div>
        
        <div class="mt-4 text-muted small" id="ocrDetails">
            <i class="fas fa-search me-1"></i> {{ _('Recherche des zones de texte...') }}
        </div>
    </div>
</div>

<!-- Étape 3: Téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation">
            <i class="fas fa-file-word"></i>
        </div>
        
        <h3 class="mb-3">{{ _('Extraction réussie !') }}</h3>
        <p class="text-muted mb-4">
            {{ _('Votre document Word est prêt au téléchargement') }}
        </p>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <a href="#" class="btn btn-success btn-lg px-5" id="downloadLink">
                <i class="fas fa-download me-2"></i>{{ _('Télécharger Word') }}
            </a>
            
            <button class="btn btn-outline-primary btn-lg px-5" onclick="resetConversion()">
                <i class="fas fa-redo me-2"></i>{{ _('Nouvelle extraction') }}
            </button>
        </div>
        
        <!-- Statistiques d'extraction -->
        <div class="row mt-5 g-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Caractères extraits') }}</h6>
                        <div class="display-6 text-primary" id="statsChars">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Mots détectés') }}</h6>
                        <div class="display-6 text-success" id="statsWords">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Lignes') }}</h6>
                        <div class="display-6 text-warning" id="statsLines">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">{{ _('Confiance') }}</h6>
                        <div class="display-6 text-info" id="statsConfidence">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let downloadUrl = null;

function startConversion() {
    const uploadManager = window.uploadManagers['imageWordUploadZone'];
    if (!uploadManager || uploadManager.getFiles().length === 0) {
        showError('{{ _("Veuillez sélectionner un fichier") }}');
        return;
    }

    const formData = new FormData();
    formData.append('file', uploadManager.getFiles()[0]);
    
    // Langues sélectionnées
    const languages = Array.from(document.querySelectorAll('input[name="languages"]:checked'))
        .map(cb => cb.value)
        .join(',');
    formData.append('languages', languages || 'fra');
    
    formData.append('confidence', document.getElementById('confidenceLevel').value);
    formData.append('preserve_layout', document.getElementById('preserveLayout').checked);
    formData.append('preprocessing', document.getElementById('preprocessing').value);
    formData.append('output_format', document.getElementById('outputFormat').value);

    // Passer à l'étape 2
    updateStep(2);
    
    // Simuler la progression OCR
    simulateOCRProgress();
    
    // Envoyer la requête
    fetch('{{ url_for("conversion.universal_converter", conversion_type="image-en-word") }}', {
        method: 'POST',
        body: formData
    })
    .then(async response => {
        if (response.ok) {
            const blob = await response.blob();
            downloadUrl = window.URL.createObjectURL(blob);
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = '{{ _("extraction.docx") }}';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (match && match[1]) {
                    filename = match[1].replace(/['"]/g, '');
                }
            }
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            
            // Simuler les statistiques d'extraction
            simulateExtractionStats();
            
            updateStep(3);
        } else {
            const error = await response.text();
            showError('{{ _("Erreur lors de l\'extraction :") }} ' + error);
            updateStep(1);
        }
    })
    .catch(error => {
        showError('{{ _("Erreur :") }} ' + error.message);
        updateStep(1);
    });
}

function simulateOCRProgress() {
    const progressBar = document.getElementById('conversionProgress');
    const ocrMessage = document.getElementById('ocrMessage');
    const ocrDetails = document.getElementById('ocrDetails');
    
    const steps = [
        { percent: 15, message: '{{ _("Prétraitement de l\'image...") }}', detail: '{{ _("Optimisation de l\'image pour l\'OCR") }}' },
        { percent: 30, message: '{{ _("Analyse des zones de texte...") }}', detail: '{{ _("Détection des paragraphes et colonnes") }}' },
        { percent: 45, message: '{{ _("Reconnaissance des caractères...") }}', detail: '{{ _("Analyse des formes et patterns") }}' },
        { percent: 60, message: '{{ _("Correction orthographique...") }}', detail: '{{ _("Vérification du vocabulaire") }}' },
        { percent: 75, message: '{{ _("Structuration du document...") }}', detail: '{{ _("Organisation en paragraphes") }}' },
        { percent: 90, message: '{{ _("Finalisation...") }}', detail: '{{ _("Préparation du document Word") }}' },
        { percent: 100, message: '{{ _("Extraction terminée !") }}', detail: '{{ _("Document prêt") }}' }
    ];
    
    let stepIndex = 0;
    
    function updateProgress() {
        if (stepIndex < steps.length) {
            const step = steps[stepIndex];
            progressBar.style.width = step.percent + '%';
            ocrMessage.textContent = step.message;
            ocrDetails.innerHTML = `<i class="fas fa-search me-1"></i> ${step.detail}`;
            
            stepIndex++;
            setTimeout(updateProgress, 800);
        }
    }
    
    updateProgress();
}

function simulateExtractionStats() {
    // Simuler des statistiques réalistes
    const chars = Math.floor(Math.random() * 2000) + 1000;
    const words = Math.floor(chars / 6);
    const lines = Math.floor(words / 12) + 1;
    const confidence = Math.floor(Math.random() * 15) + 85; // Entre 85% et 100%
    
    document.getElementById('statsChars').textContent = chars.toLocaleString();
    document.getElementById('statsWords').textContent = words.toLocaleString();
    document.getElementById('statsLines').textContent = lines;
    document.getElementById('statsConfidence').textContent = confidence + '%';
}

function resetConversion() {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
        downloadUrl = null;
    }
    
    const uploadManager = window.uploadManagers['imageWordUploadZone'];
    if (uploadManager) {
        while (uploadManager.getFiles().length > 0) {
            uploadManager.removeFile(0);
        }
    }
    
    updateStep(1);
}

// Mise à jour de l'affichage de la valeur du slider
document.addEventListener('DOMContentLoaded', function() {
    const confidenceSlider = document.getElementById('confidenceLevel');
    const confidenceValue = document.getElementById('confidenceValue');
    
    confidenceSlider.addEventListener('input', function() {
        confidenceValue.textContent = this.value + '%';
    });
    
    // Activer/désactiver le bouton selon la sélection de fichier
    const uploadManager = window.uploadManagers?.['imageWordUploadZone'];
    if (uploadManager) {
        const originalHandleFiles = uploadManager.handleFiles;
        uploadManager.handleFiles = function(fileList) {
            originalHandleFiles.call(this, fileList);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
        
        const originalRemoveFile = uploadManager.removeFile;
        uploadManager.removeFile = function(index) {
            originalRemoveFile.call(this, index);
            document.getElementById('convertBtn').disabled = this.getFiles().length === 0;
        };
    }
});

window.addEventListener('beforeunload', () => {
    if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
    }
});
</script>

{% endblock %}
