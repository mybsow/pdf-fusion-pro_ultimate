{% extends "base.html" %}

{% block head %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
.upload-area {
    border: 3px dashed #28a745;
    border-radius: 15px;
    padding: 3rem 1rem;
    text-align: center;
    background: #f8f9fa;
    transition: 0.3s;
    cursor: pointer;
}

.upload-area:hover {
    background: #e8f5e9;
    border-color: #1e7e34;
}

.upload-icon {
    font-size: 4rem;
    color: #28a745;
    margin-bottom: 1rem;
}

.file-preview {
    max-width: 100%;
    max-height: 300px;
    margin-top: 1rem;
    border-radius: 10px;
    display: none;
}

.ocr-options {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

.sticky-top {
    position: sticky;
    top: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <a href="{{ url_for('conversion.index') }}" class="btn btn-outline-primary mb-3">
                <i class="fas fa-arrow-left"></i> Retour aux conversions
            </a>
            <h1 class="display-5"><i class="fas fa-file-word me-2"></i> Image vers Word</h1>
            <p class="lead">Convertissez images et PDF en documents Word éditables</p>
        </div>
    </div>

    <div class="row">
        <!-- Zone principale -->
        <div class="col-lg-8">

            <!-- Upload -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h4 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i> Étape 1 : Sélectionnez votre fichier</h4>
                </div>
                <div class="card-body">
                    <div class="upload-area text-center" id="dropArea">
                        <div class="upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>

                        <h3>Déposez votre fichier ici</h3>
                        <p class="text-muted">ou cliquez pour parcourir</p>

                        <p class="small text-muted">
                            Formats supportés:
                            {% for ext in supported_formats.word %}
                                <span class="badge bg-light text-dark">{{ ext }}</span>
                            {% endfor %}
                        </p>

                        <input type="file"
                               id="fileInput"
                               accept=".jpg,.jpeg,.png,.gif,.bmp,.tiff,.tif,.webp,.pdf"
                               hidden>

                        <button class="btn btn-success btn-lg"
                                onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-1"></i> Sélectionner un fichier
                        </button>
                    </div>

                    <!-- Preview -->
                    <img id="filePreview" class="file-preview" alt="Aperçu">

                    <div id="fileInfo" style="display:none;">
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-1"></i>
                                <strong id="fileName"></strong>
                                <span id="fileSize" class="text-muted"></span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                <i class="fas fa-trash"></i> Changer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h4 class="mb-0"><i class="fas fa-cog me-2"></i> Étape 2 : Options</h4>
                </div>
                <div class="card-body">
                    <!-- OCR -->
                    <div class="ocr-options">
                        <h5><i class="fas fa-font me-2"></i> OCR</h5>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="ocrEnabled" checked>
                            <label class="form-check-label">
                                <strong>Activer l'OCR</strong>
                            </label>
                        </div>

                        <div id="ocrLanguageGroup">
                            <label class="form-label">Langue</label>
                            <div class="row">
                                {% for code, name in languages %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="radio"
                                               name="language"
                                               value="{{ code }}"
                                               {% if code == config.OCR_DEFAULT_LANGUAGE %}checked{% endif %}>
                                        <label class="form-check-label">
                                            {{ name }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Layout -->
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Taille de page</label>
                            <select class="form-select" id="pageSize">
                                <option>A4</option>
                                <option>Letter</option>
                                <option>Legal</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Recadrage</label>
                            <select class="form-select" id="cropMode">
                                <option value="none">Aucun</option>
                                <option value="margins">Supprimer marges</option>
                                <option value="edges">Détecter bords</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Amélioration</label>
                            <select class="form-select" id="enhancement">
                                <option value="none">Aucune</option>
                                <option value="autocontrast">Contraste auto</option>
                                <option value="sharpness">Netteté</option>
                                <option value="both">Les deux</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Compression</label>
                            <div class="btn-group w-100">
                                <input type="radio" class="btn-check" name="compression" value="high" checked>
                                <label class="btn btn-outline-success">Haute</label>

                                <input type="radio" class="btn-check" name="compression" value="medium">
                                <label class="btn btn-outline-success">Moyenne</label>

                                <input type="radio" class="btn-check" name="compression" value="low">
                                <label class="btn btn-outline-success">Optimisée</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Convert -->
            <div class="card text-center">
                <div class="card-body">
                    <button class="btn btn-success btn-lg px-5 py-3"
                            id="convertBtn"
                            onclick="convertToWord()"
                            disabled>
                        <i class="fas fa-play me-2"></i> Convertir en Word
                    </button>
                </div>
            </div>

            <div class="alert alert-info mt-4">
                <strong>Note :</strong>
                Taille max : {{ config.MAX_IMAGE_SIZE // (1024*1024) }} MB
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top:20px;">
                <div class="card-header bg-success text-white">
                    Guide rapide
                </div>
                <div class="card-body">
                    <ol>
                        <li>Sélectionnez un fichier</li>
                        <li>Configurez les options</li>
                        <li>Téléchargez le Word</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;
const maxSize = {{ config.MAX_IMAGE_SIZE }};

const fileInput = document.getElementById('fileInput');
const convertBtn = document.getElementById('convertBtn');

fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > maxSize){
        alert("Fichier trop volumineux");
        return;
    }

    selectedFile = file;

    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent =
        ` (${(file.size/1024/1024).toFixed(2)} MB)`;

    document.getElementById('fileInfo').style.display = 'block';
    convertBtn.disabled = false;

    if (file.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload = e => {
            const preview = document.getElementById('filePreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

async function convertToWord(){
    if (!selectedFile) return;

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('ocr', document.getElementById('ocrEnabled').checked);
    
    // Ajout des autres options
    formData.append('pageSize', document.getElementById('pageSize').value);
    formData.append('cropMode', document.getElementById('cropMode').value);
    formData.append('enhancement', document.getElementById('enhancement').value);
    formData.append('compression', document.querySelector('input[name="compression"]:checked').value);
    formData.append('language', document.querySelector('input[name="language"]:checked').value);

    const response = await fetch("{{ url_for('conversion.image_to_word') }}",{
        method:'POST',
        body:formData
    });

    if(!response.ok){
        alert("Erreur de conversion");
        return;
    }

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'converted.docx';
    a.click();

    window.URL.revokeObjectURL(url);
}

function clearFile(){
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('fileInfo').style.display='none';
    document.getElementById('filePreview').style.display='none';
    convertBtn.disabled = true;
}

// Drag & drop support
const dropArea = document.getElementById('dropArea');

['dragover', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, e => {
        e.preventDefault();
    });
});

dropArea.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        fileInput.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
