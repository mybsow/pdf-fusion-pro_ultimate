{% extends "conversion/conversion_base.html" %}

{% block title %}Image vers Word - Convertisseur{% endblock %}

{% block converter_content %}
<!-- Étape 1: Upload -->
<div id="step1Content">
    <div class="upload-zone" id="dropZone">
        <div class="upload-icon">
            <i class="fas fa-file-word"></i>
        </div>
        
        <h3>Extrayez le texte de vos images</h3>
        <p class="text-muted mb-4">
            Convertissez images et PDF en documents Word éditables avec OCR
        </p>
        
        <div class="mb-4">
            <span class="badge bg-success me-2">
                <i class="fas fa-image me-1"></i>Images
            </span>
            <span class="badge bg-danger me-2">
                <i class="fas fa-file-pdf me-1"></i>PDF
            </span>
            <span class="badge bg-warning text-dark">
                <i class="fas fa-weight-hanging me-1"></i>Max 50MB
            </span>
        </div>
        
        <input type="file" 
               id="fileInput" 
               class="d-none" 
               accept=".jpg,.jpeg,.png,.bmp,.tiff,.tif,.webp,.pdf">
        
        <button class="btn btn-primary btn-lg px-4 py-3"
                onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-folder-open me-2"></i>
            Sélectionner un fichier
        </button>
    </div>
    
    <!-- Zone d'upload avec UploadManager -->
    <div class="upload-zone-pro mt-4" id="imageToWordUploadZone" data-info-id="imageToWordFileInfo" data-btn-id="convertBtn">
        <div class="upload-inner">
            <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
            <h4 class="upload-title">Ou utilisez notre système d'upload avancé</h4>
            <p class="upload-subtitle">Glissez-déposez vos fichiers ici</p>
            <div class="upload-info">Images ou PDF • Taille max : 50MB</div>
        </div>
        <input type="file" accept=".jpg,.jpeg,.png,.bmp,.tiff,.webp,.pdf" style="display:none;">
    </div>
    
    <div id="imageToWordFileInfo" class="file-list mt-3"></div>
    <div id="imageToWordUploadZoneThumbnails" class="upload-thumbnails d-flex flex-wrap gap-2 mt-3"></div>
    
    <!-- Options OCR avancées -->
    <div class="mt-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-robot me-2"></i>Paramètres OCR avancés
                </h5>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label class="form-label fw-bold mb-3">
                            <i class="fas fa-language me-1"></i>Langues de reconnaissance
                        </label>
                        <div class="language-grid">
                            {% for code, name in languages %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       name="languages" 
                                       value="{{ code }}"
                                       id="lang_{{ code }}"
                                       {% if code == 'fra' %}checked{% endif %}>
                                <label class="form-check-label" for="lang_{{ code }}">
                                    {{ name }}
                                    {% if code == 'fra' %}<span class="badge bg-primary ms-1">Défaut</span>{% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <label class="form-label fw-bold mb-3">
                            <i class="fas fa-sliders-h me-1"></i>Paramètres d'extraction
                        </label>
                        
                        <div class="mb-3">
                            <label class="form-label">Niveau de confiance OCR</label>
                            <input type="range" 
                                   class="form-range" 
                                   id="confidenceLevel" 
                                   min="0" 
                                   max="100" 
                                   value="70">
                            <div class="d-flex justify-content-between small">
                                <span>Bas (plus de texte)</span>
                                <span id="confidenceValue">70%</span>
                                <span>Haut (plus précis)</span>
                            </div>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="preserveLayout" checked>
                            <label class="form-check-label">
                                <strong>Conserver la mise en page</strong>
                                <small class="d-block text-muted">Maintient les paragraphes et colonnes</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Prétraitement d'image</label>
                        <select class="form-select" id="preprocessing">
                            <option value="none">Aucun</option>
                            <option value="grayscale">Niveaux de gris</option>
                            <option value="binarization" selected>Binarisation (recommandé)</option>
                            <option value="denoise">Réduction du bruit</option>
                            <option value="skew">Correction inclinaison</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Format de sortie</label>
                        <select class="form-select" id="outputFormat">
                            <option value="docx" selected>DOCX (Word moderne)</option>
                            <option value="doc">DOC (Word ancien)</option>
                            <option value="txt">TXT (texte brut)</option>
                            <option value="rtf">RTF (format riche)</option>
                        </select>
                    </div>
                </div>
                
                <div class="action-buttons mt-4">
                    <button class="btn btn-primary btn-lg" id="convertBtn" disabled>
                        <i class="fas fa-magic me-2"></i>
                        Extraire et convertir en Word
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Étape 2: Conversion -->
<div id="step2Content" style="display: none;">
    <div class="text-center py-5">
        <div class="upload-icon mb-4">
            <div class="spinner-border text-primary" style="width: 5rem; height: 5rem;" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
        
        <h3 class="mb-4">Extraction OCR en cours</h3>
        <p class="text-muted mb-4">
            Notre intelligence artificielle analyse votre document
        </p>
        
        <div class="progress-container">
            <div class="progress-bar" id="conversionProgress"></div>
        </div>
    </div>
</div>

<!-- Étape 3: Téléchargement -->
<div id="step3Content" style="display: none;">
    <div class="text-center py-5">
        <div class="success-animation">
            <i class="fas fa-file-word"></i>
        </div>
        
        <h3 class="mb-3">Extraction réussie !</h3>
        <p class="text-muted mb-4">
            Votre document Word est prêt au téléchargement
        </p>
        
        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <button class="btn btn-success btn-lg px-4 py-3" id="downloadBtn">
                <i class="fas fa-download me-2"></i>
                Télécharger Word
            </button>
            
            <button class="btn btn-outline-primary btn-lg px-4 py-3" onclick="resetConverter()">
                <i class="fas fa-redo me-2"></i>
                Nouvelle extraction
            </button>
        </div>
    </div>
</div>

<!-- Formulaire caché pour la soumission POST -->
<form method="POST" 
      action="{{ url_for('conversion.universal_converter', conversion_type='image-en-word') }}"
      enctype="multipart/form-data"
      id="hiddenForm"
      style="display: none;">
    <input type="file" name="file" id="hiddenFileInput">
</form>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/components/upload.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const convertBtn = document.getElementById('convertBtn');
    const uploadZone = document.getElementById('imageToWordUploadZone');
    const uploadManager = window.uploadManagers?.imageToWordUploadZone;
    
    // Afficher la valeur du niveau de confiance
    const confidenceSlider = document.getElementById('confidenceLevel');
    const confidenceValue = document.getElementById('confidenceValue');
    
    confidenceSlider.addEventListener('input', function() {
        confidenceValue.textContent = this.value + '%';
    });
    
    function updateButtonState() {
        convertBtn.disabled = !uploadManager?.files?.length;
    }
    
    if (uploadManager) {
        const originalHandleFiles = uploadManager.handleFiles;
        uploadManager.handleFiles = function(fileList) {
            originalHandleFiles.call(this, fileList);
            updateButtonState();
        };
        
        const originalRemoveFile = uploadManager.removeFile;
        uploadManager.removeFile = function(index) {
            originalRemoveFile.call(this, index);
            updateButtonState();
        };
    }
    
    convertBtn.addEventListener('click', async function() {
        if (!uploadManager?.files?.length) {
            alert('Veuillez sélectionner un fichier');
            return;
        }
        
        const file = uploadManager.files[0];
        document.getElementById('step1Content').style.display = 'none';
        document.getElementById('step2Content').style.display = 'block';
        
        // Simuler la progression
        const progressBar = document.getElementById('conversionProgress');
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            progressBar.style.width = progress + '%';
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('step2Content').style.display = 'none';
                    document.getElementById('step3Content').style.display = 'block';
                }, 500);
            }
        }, 300);
        
        // Préparer le téléchargement
        const formData = new FormData();
        formData.append('file', file);
        formData.append('languages', 
            Array.from(document.querySelectorAll('input[name="languages"]:checked')).map(cb => cb.value).join(','));
        formData.append('confidence', confidenceSlider.value);
        formData.append('preserve_layout', document.getElementById('preserveLayout').checked);
        formData.append('preprocessing', document.getElementById('preprocessing').value);
        formData.append('output_format', document.getElementById('outputFormat').value);
        
        document.getElementById('downloadBtn').onclick = async function() {
            const response = await fetch("{{ url_for('conversion.universal_converter', conversion_type='image-en-word') }}", {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name.replace(/\.[^/.]+$/, '') + '.' + 
                    (document.getElementById('outputFormat').value === 'txt' ? 'txt' : 'docx');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        };
    });
});

function resetConverter() {
    const uploadManager = window.uploadManagers?.imageToWordUploadZone;
    if (uploadManager) {
        while (uploadManager.files.length > 0) {
            uploadManager.removeFile(0);
        }
    }
    document.getElementById('step1Content').style.display = 'block';
    document.getElementById('step2Content').style.display = 'none';
    document.getElementById('step3Content').style.display = 'none';
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/components/upload.js') }}"></script>
{% endblock %}