services:
  - type: web
    name: pdf-fusion-pro-ultimate
    repo: https://github.com/mybsow/pdf-fusion-pro_ultimate
    region: frankfurt
    plan: free
    branch: main
    autoDeploy: true

    envVars:
      - key: PORT
        value: "10000"
      - key: OCR_ENABLED
        value: "true"
      - key: RENDER
        value: "true"
      - key: DISABLE_POETRY
        value: "true"

    # ‚úÖ TRUCE : Utiliser une commande shell complexe
    buildCommand: |
      echo "üõ†Ô∏è D√âBUT DU BUILD PERSONNALIS√â..."
      echo "Python avant: $(python --version)"
      
      # FORCER l'installation des d√©pendances syst√®me
      apt-get update
      apt-get install -y \
          tesseract-ocr \
          tesseract-ocr-fra \
          tesseract-ocr-eng \
          poppler-utils \
          libreoffice
      
      # Installer pip packages MANUELLEMENT
      python -m pip install --upgrade pip
      python -m pip install pytesseract==0.3.10
      python -m pip install pdf2image==1.16.3
      python -m pip install Pillow==10.0.0
      python -m pip install opencv-python-headless==4.8.1.78
      
      # V√©rifier
      echo "‚úÖ V√âRIFICATION..."
      python -c "
      import sys
      print('Python:', sys.version)
      try:
          import pytesseract
          print('‚úÖ pytesseract OK')
          import pytesseract; print('Version:', pytesseract.__version__)
      except Exception as e:
          print('‚ùå pytesseract:', e)
      "
      
      # Installer le reste
      if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
      fi

    startCommand: gunicorn --bind 0.0.0.0:$PORT --workers 1 --threads 4 app:app

    # ‚úÖ FORCER les packages syst√®me
    aptPackages:
      - tesseract-ocr
      - tesseract-ocr-fra
      - tesseract-ocr-eng
      - tesseract-ocr-spa
      - poppler-utils
      - libreoffice
      - unoconv

    healthCheckPath: /health
    healthCheckTimeout: 30
