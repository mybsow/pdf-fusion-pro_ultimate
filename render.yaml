services:
  - type: web
    name: pdf-fusion-pro-ultimate
    repo: https://github.com/mybsow/pdf-fusion-pro_ultimate
    region: frankfurt
    plan: free
    branch: main
    autoDeploy: true

    envVars:
      - key: PORT
        value: "10000"
      - key: OCR_ENABLED
        value: "true"
      - key: PYTHON_VERSION
        value: "3.11.0"

    # ‚úÖ BUILD COMMAND OPTIMIS√â
    buildCommand: |
      echo "üöÄ D√âMARRAGE DU BUILD PDF FUSION PRO..."
      
      # 1. Installer Tesseract OCR (version syst√®me)
      apt-get update
      apt-get install -y tesseract-ocr tesseract-ocr-fra poppler-utils
      
      # 2. V√©rifier l'installation
      echo "‚úÖ V√©rification OCR..."
      which tesseract && tesseract --version
      which pdftoppm
      
      # 3. Installer pip et packages Python
      pip install --upgrade pip
      
      # 4. Installer les packages OCR CRITIQUES
      pip install \
        pytesseract==0.3.10 \
        pdf2image==1.16.3 \
        Pillow==10.0.0 \
        opencv-python-headless==4.8.1.78 \
        pandas==2.1.4
      
      # 5. Installer le reste depuis requirements.txt
      if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
      fi
      
      # 6. V√©rification finale
      echo "üß™ V√âRIFICATION FINALE..."
      python -c "
      import sys
      print('Python:', sys.version)
      
      packages = ['pytesseract', 'pdf2image', 'PIL', 'cv2', 'pandas']
      for pkg in packages:
          try:
              if pkg == 'PIL':
                  import PIL
                  print(f'‚úÖ {pkg}: OK')
              else:
                  __import__(pkg)
                  print(f'‚úÖ {pkg}: OK')
          except ImportError as e:
              print(f'‚ùå {pkg}: {e}')
      "
      
      echo "‚úÖ BUILD COMPLET"

    startCommand: gunicorn --bind 0.0.0.0:$PORT --workers 1 app:app

    # ‚úÖ Ajouter aptPackages pour le cache Render
    aptPackages:
      - tesseract-ocr
      - tesseract-ocr-fra
      - poppler-utils

    healthCheckPath: /health
    healthCheckTimeout: 30
