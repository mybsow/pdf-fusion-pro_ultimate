services:
  - type: web
    name: pdf-fusion-pro-ultimate
    repo: https://github.com/mybsow/pdf-fusion-pro_ultimate
    region: frankfurt
    plan: free
    branch: main
    autoDeploy: true

    envVars:
      - key: FLASK_ENV
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: WEB_CONCURRENCY
        value: "1"
      - key: PORT
        value: "10000"
      - key: OCR_ENABLED
        value: "true"
      - key: ADMIN_PASSWORD
        value: "admin123"

    # ‚úÖ BUILD COMMAND AVEC PREINSTALLATION OCR
    buildCommand: |
      echo "üöÄ D√âBUT DU BUILD PDF FUSION PRO..."
      
      # 1. Ex√©cuter le script d'installation OCR
      chmod +x predeploy.sh
      ./predeploy.sh
      
      # 2. Installer les autres requirements
      echo "üì¶ Installation des autres d√©pendances..."
      pip install --upgrade pip
      pip install -r requirements.txt
      
      # 3. V√©rification finale
      echo "‚úÖ V√âRIFICATION FINALE..."
      python -c "
      import sys
      print('Python:', sys.version)
      
      packages = ['pytesseract', 'pdf2image', 'PIL', 'cv2', 'pandas']
      for pkg in packages:
          try:
              if pkg == 'PIL':
                  __import__('PIL')
              else:
                  __import__(pkg)
              print(f'‚úÖ {pkg}: OK')
          except ImportError as e:
              print(f'‚ùå {pkg}: {e}')
      "
      
      echo "üèÅ BUILD TERMIN√â AVEC SUCC√àS !"

    startCommand: gunicorn --bind 0.0.0.0:$PORT --workers 1 --threads 4 --worker-class gthread app:app

    # ‚úÖ M√™me si on utilise predeploy.sh, gardons aptPackages pour le cache
    aptPackages:
      - tesseract-ocr
      - tesseract-ocr-fra
      - tesseract-ocr-eng
      - tesseract-ocr-spa
      - tesseract-ocr-deu
      - tesseract-ocr-ita
      - poppler-utils
      - libreoffice
      - unoconv
      - libsm6
      - libxext6
      - libxrender-dev
      - libgl1-mesa-glx

    healthCheckPath: /health
    healthCheckTimeout: 30

    disk:
      name: tmp
      mountPath: /tmp
      sizeGB: 1
